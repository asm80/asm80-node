/*

Multitarget assembler (C) 2013 Martin Maly, http://www.maly.cz, http://www.webscript.cz

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.

 Parser is based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/

/* jshint browser:true, jquery:true */
/*global define, Uint8Array*/
/* eslint-disable no-empty */

var ASM = {};
  var Parser = require("./parser.js").Parser;
!function(e,o){"undefined"!=typeof module?(module.exports=o(),ASM=module.exports):"function"==typeof define&&"object"==typeof define.amd?define(o):this.ASM=o()}(0,function(){"use strict";var e=null,o=null,n={},r=!1,a=function(e){return e.map(function(e){var o=e.line;for(o=(o=o.replace("&lt;","<")).replace("&gt;",">");" "==o[o.length-1];)o=o.substr(0,o.length-1);if(e.line=o," "!=o[0])return e;for(;" "==o[0];)o=o.substr(1);return e.line=" "+o,e})},l=function(e){return e.filter(function(e){for(var o=e.line;" "==o[0];)o=o.substr(1);return!!o.length})},t=function(e){return e.map(function(e){for(var o=e.line,n={addr:0,line:";;;EMPTYLINE",numline:e.numline};" "==o[0];)o=o.substr(1);return o.length?e:n})},s=function(e){var o=1;return e.map(function(e){return{line:e,numline:o++,addr:null,bytes:0}})},i=function(e){return e.replace(/^\s+|\s+$/g,"")},p=function(o,n,r,a){var l=o.line,t=l.match(/^\s*(\@{0,1}[a-zA-Z0-9-_]+):\s*(.*)/);t&&(o.label=t[1].toUpperCase(),l=t[2]),o._dp=0,o.params=[];var s=l.match(/^\s*(\=)\s*(.*)/);if(s?(o.opcode=s[1].toUpperCase(),l=s[2]):(s=l.match(/^\s*([\.a-zA-Z0-9-_]+)\s*(.*)/))&&(o.opcode=s[1].toUpperCase(),l=s[2]),l){for(;l.match(/"(.*?);(.*?)"/g);)l=l.replace(/"(.*?);(.*?)"/g,'"$1§$2"');for(;l.match(/'(.*?);(.*?)'/g);)l=l.replace(/'(.*?);(.*?)'/g,'"$1§$2"');var c=l.match(/^\s*([^;]*)(.*)/);if(c&&c[1].length){o.paramstring=c[1];for(var d=c[1];d.match(/"(.*?),(.*?)"/g);)d=d.replace(/"(.*?),(.*?)"/g,'"$1€$2"');for(;d.match(/'(.*?),(.*?)'/g);)d=d.replace(/'(.*?),(.*?)'/g,'"$1€$2"');var f=d.match(/([0-9]+)\s*DUP\s*\((.*)\)/i);if(f){for(var u=parseInt(f[1]),h="",m=0;m<u;m++)h+=f[2]+",";d=h.substring(0,h.length-1)}var g=d.split(/\s*,\s*/);o.params=g.map(function(e){return i(e.replace(/€/g,",").replace(/§/g,";"))}),l=c[2].replace(/§/g,";")}}if(l){var v=l.match(/^\s*;*(.*)/);v&&(o.remark=v[1],o.remark||(o.remark=" "),l="")}if(o.notparsed=l,"ORG"===o.opcode&&(o.opcode=".ORG"),".ERROR"===o.opcode)throw{msg:o.paramstring,s:o};if(".EQU"===o.opcode&&(o.opcode="EQU"),".FILL"===o.opcode&&(o.opcode="FILL"),".ORG"===o.opcode)try{return o}catch(e){throw{msg:e.message,s:o}}if("DEFB"===o.opcode)return o.opcode="DB",o;if(".BYTE"===o.opcode)return o.opcode="DB",o;if(".DB"===o.opcode)return o.opcode="DB",o;if(".WORD"===o.opcode)return o.opcode="DW",o;if(".DW"===o.opcode)return o.opcode="DW",o;if("DEFW"===o.opcode)return o.opcode="DW",o;if("DEFS"===o.opcode)return o.opcode="DS",o;if(".RES"===o.opcode)return o.opcode="DS",o;if("DEFM"===o.opcode)return o.opcode="DS",o;if(".ALIGN"===o.opcode)return o.opcode="ALIGN",o;if(".IF"===o.opcode)return o.opcode="IF",o;if(".ELSE"===o.opcode)return o.opcode="ELSE",o;if(".ENDIF"===o.opcode)return o.opcode="ENDIF",o;if(".PRAGMA"===o.opcode)return ASM.PRAGMAS=ASM.PRAGMAS||[],ASM.PRAGMAS.push(o.params[0].toUpperCase()),o;if("EQU"===o.opcode||"="===o.opcode||".SET"===o.opcode||"IF"===o.opcode||"IFN"===o.opcode||"ELSE"===o.opcode||"ENDIF"===o.opcode||".INCLUDE"===o.opcode||".INCBIN"===o.opcode||".MACRO"===o.opcode||".ENDM"===o.opcode||".BLOCK"===o.opcode||".ENDBLOCK"===o.opcode||".REPT"===o.opcode||".CPU"===o.opcode||".ENT"===o.opcode||".BINFROM"===o.opcode||".BINTO"===o.opcode||".ENGINE"===o.opcode||".PRAGMA"===o.opcode||"END"===o.opcode||".END"===o.opcode||"BSZ"===o.opcode||"FCB"===o.opcode||"FCC"===o.opcode||"FDB"===o.opcode||"FILL"===o.opcode||"RMB"===o.opcode||"ZMB"===o.opcode||"SETDP"===o.opcode||".M8"===o.opcode||".X8"===o.opcode||".M16"===o.opcode||".X16"===o.opcode||".PHASE"===o.opcode||".DEPHASE"===o.opcode||".SETPHASE"===o.opcode||"ALIGN"===o.opcode||".CSTR"===o.opcode||".ISTR"===o.opcode||".PSTR"===o.opcode||".CSEG"===o.opcode||".DSEG"===o.opcode||".ESEG"===o.opcode||".BSSEG"===o.opcode||"DB"===o.opcode||"DS"===o.opcode||"DW"===o.opcode)return o;if(".DEBUGINFO"===o.opcode||".MACPACK"===o.opcode||".FEATURE"===o.opcode||".ZEROPAGE"===o.opcode||".SEGMENT"===o.opcode||".SETCPU"===o.opcode)return o.opcode="",o;if(!o.opcode&&o.label)return o;try{var E=e.parseOpcode(o)}catch(e){throw{msg:e,s:o}}if(null!==E)return E;if(n[o.opcode])return o.macro=o.opcode,o;if(!o.label&&!r){var S={line:o.line,numline:o.numline,addr:null,bytes:0};if(o.remark&&!o.opcode)return o;if(!o.params||0===o.params.length)throw{msg:"Unrecognized instruction "+o.opcode,s:o};if(!o.opcode)throw{msg:"Unrecognized instruction "+o.opcode,s:o};0===o.params[0].indexOf(":=")&&(o.params[0]=o.params[0].substr(1)),S.line=o.opcode+": "+o.params.join();var M=p(S,n,!0,o);if(!M.opcode)throw{msg:"Unrecognized instruction "+o.opcode,s:o};return M}if(r)throw{msg:"Unrecognized instruction "+a.opcode,s:o};throw{msg:"Unrecognized instruction "+o.opcode,s:o}},c=function(e,r){var t,p,d=null;r=r||{};for(var f={},u=null,h=null,m=[],g=0,v=e.length;g<v;g++)if(t=e[g].line,p=t.match(/\s*(\.[^\s]+)(.*)/)){var E=p[1].toUpperCase(),S=p[2].match(/^\s*([^;]*)(.*)/);if(S&&S[1].length?(S[1],d=S[1].split(/\s*,\s*/).map(i)):d=null,".INCLUDE"!==E||!r.noinclude)if(".INCLUDE"!==E)if(".ENDM"!==E)if(".MACRO"!==E)if(".REPT"!==E)u?f[u].push(e[g]):m.push(e[g]);else{if(!d[0])throw{msg:"No repeat count given",s:e[g]};if(!(h=Parser.evaluate(d[0])))throw{msg:"Bad repeat count given",s:e[g]};if(u="*REPT"+e[g].numline,f[u])throw{msg:"Macro redefinition at line "+e[g].numline,s:e[g]};f[u]=[]}else{if(!d[0])throw{msg:"Bad macro name at line "+e[g].numline,s:e[g]};if(u=d[0].toUpperCase(),f[u])throw{msg:"Macro redefinition at line "+e[g].numline,s:e[g]};f[u]=[]}else{if(!u)throw{msg:"ENDM without MACRO at line "+e[g].numline,s:e[g]};if(h){m.push({numline:e[g].numline,line:";rept unroll",addr:null,bytes:0,remark:"REPT unroll"});for(var M=0;M<h;M++)for(var A=0;A<f[u].length;A++){var b=f[u][A].line;m.push({numline:e[M].numline,line:b,addr:null,bytes:0})}}u=null,h=null}else{if(!d||!d[0])throw{msg:"No file name given",s:e[g]};if(n[d[0].replace(/\"/g,"")])throw{msg:"File "+d[0].replace(/\"/g,"")+" is already included elsewhere - maybe recursion",s:e[g]};var N=o(d[0].replace(/\"/g,""));if(!N)throw{msg:"File "+d[0]+" not found",s:e[g]};var P=s(N.split(/\n/));P=l(P),P=a(P);for(var y=c(P),C=0;C<y[0].length;C++)y[0][C].includedFile=d[0].replace(/\"/g,""),m.push(y[0][C]);for(C in y[1])f[C]=y[1][C];n[d[0].replace(/\"/g,"")]=N}}else{if(u){f[u].push(e[g]);continue}m.push(e[g])}if(u)throw{msg:"MACRO "+u+" has no appropriate ENDM",s:e[g]};return[m,f]},d=function(e,o,n){var r={line:e.line,addr:e.addr,macro:e.macro,numline:e.numline};o=o||[];for(var a=0;a<o.length;a++)r.line=r.line.replace("%%"+(a+1),o[a]);return r.line=r.line.replace("%%M","M_"+n),r.line=r.line.replace("%%m","M_"+n),r},f=function(e,o){for(var n=[],r=0;r<e.length;r++){var a=e[r];if(a.macro)for(var l=o[a.macro],t=0;t<l.length;t++){var s=p(d(l[t],a.params,r),o);a.label&&(s.label=a.label),a.label="",s.remark=a.remark,s.macro=a.macro,a.macro=null,a.remark="",n.push(s)}else n.push(a)}return n},u={},h=function(e,o){for(var n=e.toString(16);n.length<o;)n="0"+n;return n.toUpperCase()},m=function(e){return h(255&e,2)},g=function(e){return h(e,4)},v=function(e){return h(e,6)},E=function(e){if(ASM.PRAGMAS.RELAX)return"string"==typeof e?255&e.charCodeAt(0):255&e;if("string"==typeof e){if(1!=e.length)throw"String parameter too long ("+e+")";return 255&e.charCodeAt(0)}if(e>255)throw"Param out of bound ("+e+")";if(e<-128)throw"Param out of bound ("+e+")";return 255&e},S=function(e,o){var n=":",r=o.length,a=0;n+=m(r),n+=g(e),n+="00",a=r+Math.floor(e/256)+Math.floor(e%256);for(var l=0;l<o.length;l++)n+=m(o[l]),a+=o[l];return n+=m(256-a%256)},M=function(e,o,n){var r=0,a=[],l=16;n>1&&(l=n);for(var t="",s=0;s<o.length;s++)a.push(o[s]),++r===l&&(t+=S(e,a)+"\n",a=[],r=0,e+=l);return a.length&&(t+=S(e,a)+"\n"),t},A=function(e,o){var n="S1",r=o.length,a=0;n+=m(r+3),n+=g(e),a=r+3+Math.floor(e/256)+Math.floor(e%256);for(var l=0;l<o.length;l++)n+=m(o[l]),a+=o[l];return n+=m(256-a%256)},b=function(e,o){for(var n=0,r=[],a="",l=0;l<o.length;l++)r.push(o[l]),16==++n&&(a+=A(e,r)+"\n",r=[],n=0,e+=16);return r.length&&(a+=A(e,r)+"\n"),a},N=function(e,o){var n="S2",r=o.length,a=0;n+=m(r+4),n+=v(e),a=r+4+Math.floor(e/65536)+Math.floor(e/256)%256+Math.floor(e%256);for(var l=0;l<o.length;l++)n+=m(o[l]),a+=o[l];return n+=m(255-a%256)},P=function(e,o){for(var n=0,r=[],a="",l=0;l<o.length;l++)r.push(o[l]),16==++n&&(a+=N(e,r)+"\n",r=[],n=0,e+=16);return r.length&&(a+=N(e,r)+"\n"),a};return{parse:function(o,t){e=t,t.endian&&(r=t.endian),n={};var i=s(o.split(/\n/));i=l(i),i=a(i);var d=c(i);return i=d[0].map(function(e){return p(e,d[1])}),i=f(i,d[1])},pass1:function(n,r){var a="CSEG",l=function(){if("BSSEG"===a)throw f.opcode+" is not allowed in BSSEG"},t={},s=0,i={};r&&(i=r);for(var p,c,d,f=null,h=0,m=0,g=[],v=0,E=0,S=0,M=n.length;S<M;S++)if(f=n[S],ASM.WLINE=n[S],f.pass=1,f.segment=a,f.addr=s,f._dp=E,i._PC=s,0!==v&&(f.phase=v),"ENDIF"!==f.opcode)if("ELSE"!==f.opcode)if(h)f.ifskip=!0;else if("IF"!==f.opcode)if("IFN"!==f.opcode)if(".BLOCK"!==f.opcode)if(".ENDBLOCK"!==f.opcode){if(f.label){var A=f.label,b=!1;if("@"===A[0]&&(b=!0,A=A.substr(1),f.label=A,f.beGlobal=!0),f.beGlobal&&(b=!0),g.length>0&&(A=g.join("/")+"/"+A,i["__"+g.join("/")].push(f.label)),!r&&(i[A+"$"]||b&&void 0!==i[f.label]))throw{msg:"Redefine label "+f.label+" at line "+f.numline,s:f};i[f.label]?i[A]=i[f.label]:b&&(i[A]=s),u[f.label]={defined:{line:f.numline,file:f.includedFile||"*main*"},value:s},i[A+"$"]=s,i[f.label]=s,b&&(i[A]=s)}try{if(".ORG"===f.opcode){s=Parser.evaluate(f.params[0],i),f.addr=s,t[a]=s;continue}if(".CSEG"===f.opcode&&(t[a]=s,a="CSEG",f.segment=a,s=t[a]||0,f.addr=s),".DSEG"===f.opcode&&(t[a]=s,a="DSEG",f.segment=a,s=t[a]||0,f.addr=s),".ESEG"===f.opcode&&(t[a]=s,a="ESEG",f.segment=a,s=t[a]||0,f.addr=s),".BSSEG"===f.opcode&&(t[a]=s,a="BSSEG",f.segment=a,s=t[a]||0,f.addr=s),".PHASE"===f.opcode){if(v)throw{message:"PHASE cannot be nested"};var N=Parser.evaluate(f.params[0],i);f.addr=s,v=N-s,s=N;continue}if(".DEPHASE"===f.opcode){f.addr=s,s-=v,v=0;continue}if("EQU"===f.opcode||".SET"===f.opcode){try{i[f.label]=Parser.evaluate(f.params[0],i)}catch(e){i[f.label]=null}u[f.label]={defined:{line:f.numline,file:f.includedFile||"*main*"},value:i[f.label]};continue}if("="===f.opcode||":="===f.opcode){i[f.label]=Parser.evaluate(f.params[0],i),u[f.label]={defined:{line:f.numline,file:f.includedFile||"*main*"},value:i[f.label]};continue}}catch(e){throw{msg:e.message,s:f}}if("DB"===f.opcode||"FCB"===f.opcode)for(l(),f.bytes=0,c=0;c<f.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(f.params[c],i))){f.bytes++;continue}if("string"==typeof p){f.bytes+=p.length;continue}}catch(e){f.bytes++}if(".CSTR"===f.opcode||".PSTR"===f.opcode||".ISTR"===f.opcode){for(l(),f.bytes=0,c=0;c<f.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(f.params[c],i))){f.bytes++;continue}if("string"==typeof p){f.bytes+=p.length;continue}}catch(e){f.bytes++}".CSTR"!==f.opcode&&".PSTR"!==f.opcode||f.bytes++}if("DS"!==f.opcode&&"RMB"!==f.opcode)if("ALIGN"!==f.opcode)if("SETDP"!==f.opcode)if("FILL"!==f.opcode)if("BSZ"!==f.opcode&&"ZMB"!==f.opcode){if("DW"===f.opcode||"FDB"===f.opcode)for(l(),f.bytes=0,c=0;c<f.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(f.params[c],i))){f.bytes+=2;continue}}catch(e){f.bytes+=2}if(".INCBIN"!==f.opcode)if(".M16"!==f.opcode)if(".M8"!==f.opcode)if(".X16"!==f.opcode)if(".X8"!==f.opcode){var P=e.parseOpcode(n[S],i);P&&(l(),f=P),void 0===f.bytes&&(f.bytes=0),s+=f.bytes}else i.__MX=8;else i.__MX=16;else i.__AX=8;else i.__AX=16;else{if(l(),!f.params[0])throw{msg:"No file name given at line "+f.numline,s:f};var y=o(f.params[0],!0);if(!y)throw{msg:"Cannot find file "+f.params[0]+" for incbin",s:f};for(f.bytes=0,f.lens=[],R=0;R<y.length;R++){var C=y.charCodeAt(R);C>255&&(f.lens[f.bytes++]=C>>8),f.lens[f.bytes++]=C%256}s+=f.bytes}}else{for(l(),D=Parser.evaluate(f.params[0],i),f.bytes=D,f.lens=[],R=0;R<D;R++)f.lens[R]=0;s+=D}else{for(l(),D=Parser.evaluate(f.params[1],i),"string"==typeof(p=Parser.evaluate(f.params[0],i))&&(p=p.charCodeAt(0)),f.bytes=D,f.lens=[],R=0;R<D;R++)f.lens[R]=p;s+=D}else E=Parser.evaluate(f.params[0],i);else{var I=Parser.evaluate(f.params[0],i);s+=s%I>0?I-s%I:0}else{var D=Parser.evaluate(f.params[0],i);if(2==f.params.length){"string"==typeof(p=Parser.evaluate(f.params[1],i))&&(p=p.charCodeAt(0)),f.bytes=D,f.lens=[];for(var R=0;R<D;R++)f.lens[R]=p}s+=D}}else{for(var F=i["__"+g.join("/")],G=0;G<F.length;G++)i[F[G]]=i[g.join("/")+"/"+F[G]],delete i[g.join("/")+"/"+F[G]];g.pop(),i.__blocks=JSON.stringify(g)}else{g.push(f.numline);var B=g.join("/");i["__"+B]=[]}else{if(m)throw{msg:"Nested IFs are not supported",s:f};try{(d=Parser.evaluate(f.params[0],i))&&(h=1),m=1}catch(e){throw{msg:"IF condition can not be determined",s:f}}}else{if(m)throw{msg:"Nested IFs are not supported",s:f};try{d=Parser.evaluate(f.params[0],i)}catch(e){}d||(h=1),m=1}else{if(!m)throw{msg:"ELSE without IF",s:f};h=h?0:1}else{if(!m)throw{msg:"ENDIF without IF",s:f};h=0,m=0}return[n,i]},pass2:function(e){for(var o,n,a,l=e[0],t=e[1],s=null,i=null,p=[],c=0,d=0,f=l.length;d<f;d++)try{if(s=l[d],s.pass=2,"ENDIF"===s.opcode){c=0;continue}if("ELSE"===s.opcode){c=c?0:1;continue}if(c)continue;if("IF"===s.opcode){Parser.evaluate(s.params[0],t);try{Parser.evaluate(s.params[0],t)||(c=1)}catch(e){throw{message:"IF condition mismatched"}}continue}if("IFN"===s.opcode){try{Parser.evaluate(s.params[0],t)&&(c=1)}catch(e){throw{message:"IF condition mismatched"}}continue}t._PC=s.addr;try{for(var h=Parser.usage(s.params[0].toUpperCase(),t),m=0;m<h.length;m++)u[h[m]].usage||(u[h[m]].usage=[]),u[h[m]].usage.push({line:s.numline,file:s.includedFile||"*main*"})}catch(e){}try{for(var h=Parser.usage(s.params[1].toUpperCase(),t),m=0;m<h.length;m++)u[h[m]].usage||(u[h[m]].usage=[]),u[h[m]].usage.push({line:s.numline,file:s.includedFile||"*main*"})}catch(e){}if(".BLOCK"===s.opcode){p.push(s.numline);for(var g=t["__"+p.join("/")],v=0;v<g.length;v++)t[p.join("/")+"/"+g[v]]=t[g[v]],t[g[v]]=t[p.join("/")+"/"+g[v]+"$"];continue}if(".ENDBLOCK"===s.opcode){for(var g=t["__"+p.join("/")],v=0;v<g.length;v++)t[g[v]]=t[p.join("/")+"/"+g[v]],void 0===t[g[v]]&&delete t[g[v]],t[p.join("/")+"/"+g[v]]=null;p.pop();continue}if(".ENT"===s.opcode){ASM.ENT=Parser.evaluate(s.params[0],t);continue}if(".BINFROM"===s.opcode){ASM.BINFROM=Parser.evaluate(s.params[0],t);continue}if(".BINTO"===s.opcode){ASM.BINTO=Parser.evaluate(s.params[0],t);continue}if(".SETPHASE"===s.opcode){ASM.PHASES||(ASM.PHASES={}),ASM.PHASES[s.addr]=s.params[0];continue}if(".ENGINE"===s.opcode){ASM.ENGINE=s.params[0];continue}if("EQU"===s.opcode){t[s.label]=Parser.evaluate(s.params[0],t);continue}if(".SET"===s.opcode){t[s.label]=Parser.evaluate(s.params[0],t);continue}if("DB"===s.opcode||"FCB"===s.opcode){for(n=0,s.lens=[],a=0;a<s.params.length;a++)if("number"!=typeof(o=Parser.evaluate(s.params[a],t)))if("string"!=typeof o);else for(S=0;S<o.length;S++)s.lens[n++]=o.charCodeAt(S);else s.lens[n++]=Math.floor(o%256);continue}if(".CSTR"===s.opcode){for(n=0,s.lens=[],a=0;a<s.params.length;a++)if("number"!=typeof(o=Parser.evaluate(s.params[a],t)))if("string"!=typeof o);else for(S=0;S<o.length;S++)s.lens[n++]=o.charCodeAt(S);else s.lens[n++]=Math.floor(o%256);s.lens[n++]=0;continue}if(".PSTR"===s.opcode){for(n=1,s.lens=[],a=0;a<s.params.length;a++)if("number"!=typeof(o=Parser.evaluate(s.params[a],t)))if("string"!=typeof o);else for(S=0;S<o.length;S++)s.lens[n++]=o.charCodeAt(S);else s.lens[n++]=Math.floor(o%256);s.lens[0]=n-1;continue}if(".ISTR"===s.opcode){for(n=0,s.lens=[],a=0;a<s.params.length;a++)if("number"!=typeof(o=Parser.evaluate(s.params[a],t)))if("string"!=typeof o);else for(var S=0;S<o.length;S++)s.lens[n++]=127&o.charCodeAt(S);else s.lens[n++]=Math.floor(o%128);s.lens[n-1]=128|s.lens[n-1];continue}if("DW"===s.opcode||"FDB"===s.opcode){for(n=0,s.lens=[],a=0;a<s.params.length;a++)"number"!=typeof(o=Parser.evaluate(s.params[a],t))||(r?(s.lens[n++]=Math.floor(o/256),s.lens[n++]=Math.floor(o%256)):(s.lens[n++]=Math.floor(o%256),s.lens[n++]=Math.floor(o/256)));continue}if(s.lens&&s.lens[1]&&"function"==typeof s.lens[1]&&("addr24"===s.lens[2]?(i=s.lens[1](t),r?(s.lens[3]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[1]=Math.floor(i>>16&255)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[3]=Math.floor(i>>16&255))):"addr32"===s.lens[2]?(i=s.lens[1](t),r?(s.lens[4]=Math.floor(i%256),s.lens[3]=Math.floor((i>>8)%256),s.lens[2]=Math.floor(i>>16&255),s.lens[1]=Math.floor(i>>24&255)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[3]=Math.floor(i>>16&255),s.lens[4]=Math.floor(i>>24&255))):null===s.lens[2]?"string"==typeof(i=s.lens[1](t))?r?(s.lens[1]=255&i.charCodeAt(0),s.lens[2]=255&i.charCodeAt(1)):(s.lens[2]=255&i.charCodeAt(0),s.lens[1]=255&i.charCodeAt(1)):r?(s.lens[2]=Math.floor(i%256),s.lens[1]=Math.floor(i/256)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor(i/256)):(i=s.lens[1](t),s.lens[1]=E(i))),s.lens&&s.lens.length>2&&"function"==typeof s.lens[2]&&(i=s.lens[2](t),null===s.lens[3]?"string"==typeof(i=s.lens[2](t))?r?(s.lens[2]=255&i.charCodeAt(0),s.lens[3]=255&i.charCodeAt(1)):(s.lens[3]=255&i.charCodeAt(0),s.lens[2]=255&i.charCodeAt(1)):r?(s.lens[3]=255&i,s.lens[2]=i>>8):(s.lens[2]=255&i,s.lens[3]=i>>8):s.lens[2]=E(i)),s.lens&&s.lens.length>3&&"function"==typeof s.lens[3]&&(i=s.lens[3](t),null===s.lens[4]?"string"==typeof(i=s.lens[3](t))?r?(s.lens[3]=255&i.charCodeAt(0),s.lens[4]=255&i.charCodeAt(1)):(s.lens[4]=255&i.charCodeAt(0),s.lens[3]=255&i.charCodeAt(1)):r?(s.lens[4]=255&i,s.lens[3]=i>>8):(s.lens[3]=255&i,s.lens[4]=i>>8):s.lens[3]=E(i)),s.lens&&s.lens.length>1){if("string"==typeof s.lens[1]&&(s.lens[1]=s.lens[1].charCodeAt(0)),isNaN(s.lens[1]))throw console.log(1201,s),{message:"param out of bounds, NaN"};if((s.lens[1]>255||s.lens[1]<-128)&&2==s.lens.length)throw{message:"param out of bounds - "+s.lens[1]};s.lens[1]<0&&(s.lens[1]=256+s.lens[1])}}catch(e){throw{msg:e.message,s:s,e:e}}return[l,t]},parseLine:p,ENT:null,WLINE:null,compile:function(e,o){try{ASM.ENT=null,ASM.BINFROM=null,ASM.BINTO=null,ASM.ENGINE=null,ASM.PRAGMAS=[];var n=ASM.parse(e,o);u={};var r=ASM.pass1(n);return r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass2(r),[null,r,u]}catch(e){console.log(e);var a=e.s||"Internal error";return e.e&&(e="object"==typeof e.e?e.e:{msg:e.e,s:e.s}),!e.msg&&e.message&&(e.msg=e.message),e.msg?(e.s||(e.s=a),[e,null]):["Cannot evaluate line "+ASM.WLINE.numline+", there is some unspecified error (e.g. reserved world as label etc.)",null]}},compileAsync:function(e,o,n){try{var r=ASM.parse(e,o),a=ASM.pass1(r);a=ASM.pass2(a),n(null,a)}catch(e){n(e,null)}},lst:function(e,o,n,r,a){var l,t,s="";void 0===r&&(r=!1);for(var i=0,p=e.length;i<p;i++){if(t=e[i],l="",t.macro&&!n&&(s+="        **MACRO UNROLL - "+t.macro+"\n"),void 0===t.addr||t.ifskip||(l+=g(t.addr),t.phase&&(l+=" @"+g(t.addr-t.phase)),l+=r?" ":"   "),t.lens&&!t.ifskip)for(var c=0;c<t.lens.length;c++)l+=m(t.lens[c])+" ";if(!r)for(;l.length<20;)l+=" ";if(r)for(;l.length<15;)l+=" ";if(t.label&&(l+=t.label+":   "),!r)for(;l.length<30;)l+=" ";if(r)for(;l.length<22;)l+=" ";t.opcode&&(l+=t.opcode+(r?" ":"   ")),t.bandPar&&(l+=t.bandPar+","),t.aimPar&&(l+=t.aimPar+","),t.params&&(l+=t.params+(r?" ":"   ")),t.remark&&(l+=";"+t.remark),s+=l+"\n"}if(n)return s;s+="\n\n";for(var d in u)if(null!==u[d]&&("_"!=d[0]||"_"!=d[1])&&"$"!==d[d.length-1]){for(l="",l+=d+": ";l.length<20;)l+=" ";if(l+=g(u[d].value),l+=" DEFINED AT LINE "+u[d].defined.line,"*main*"!=u[d].defined.file&&(l+=" IN "+u[d].defined.file),s+=l+"\n",u[d].usage)for(p=0;p<u[d].usage.length;p++)s+="                    > USED AT LINE "+u[d].usage[p].line,"*main*"!=u[d].usage[p].file&&(s+=" IN "+u[d].usage[p].file),s+="\n"}return s},html:function(e,o,n,r){var a,l,t="<html><head><meta charset=utf-8><body><table>";void 0===r&&(r=!1);for(var s=0,i=e.length;s<i;s++){if(l=e[s],a='<tr id="ln'+l.numline+'">',l.macro&&!n&&(a+="        **MACRO UNROLL - "+l.macro+"\n"),void 0!==l.addr?(a+='<td><a name="ADDR'+g(l.addr)+'">'+g(l.addr)+"</a>",l.phase?a+="</td><td>"+g(l.addr-l.phase):a+="</td><td>",a+="</td>"):a+="<td></td><td></td>",l.lens){a+="<td>";for(var p=0;p<l.lens.length;p++)a+=m(l.lens[p])+" ";a+="</td>"}else a+="<td></td>";l.label?a+='<td><a name="LBL'+l.label+'">'+l.label+"</a></td>":a+="<td></td>",l.opcode?a+="<td>"+l.opcode+"</td>":a+="<td></td>",l.params?a+="<td>"+l.params.map(function(e){e+="";for(var n in o)if(null!==o[n]&&("_"!=n[0]||"_"!=n[1])&&"$"!==n[n.length-1]){var r=new RegExp("^"+n+"$","i");if(e.match(r))return'<a href="#LBL'+n+'">'+e+"</a>"}return e})+"</td>":a+="<td></td>",l.remark?a+="<td>;"+l.remark+"</td>":a+="<td></td>",t+=a+"</tr>\n"}return t+="</table>"},hex:function(e,o){for(var n,r=null,a=0,l=[],t="",s=!1,i=16,p=0,c=e.length;p<c;p++)if(".PRAGMA"===(n=e[p]).opcode&&(2==n.params.length&&"HEXLEN"==n.params[0].toUpperCase()&&((i=parseInt(n.params[1]))<1||i>64)&&(i=16),1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(s=!0)),!(n.ifskip||s&&(o||(o="CSEG"),n.segment!=o))){var d=n.addr;if(n.phase&&(d-=n.phase),void 0!==d&&0===a&&(r=d),d!=r+a&&(a&&(t+=M(r,l,i)),r=d,a=0,l=[]),n.lens){for(var f=0;f<n.lens.length;f++)l.push(n.lens[f]);a+=n.lens.length}}return l.length&&(t+=M(r,l,i)),t+=":00000001FF"},srec:function(e,o){for(var n,r=null,a=0,l=!1,t=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(n=e[i]).opcode&&1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(l=!0),!(n.ifskip||l&&(o||(o="CSEG"),n.segment!=o))){var c=n.addr;if(n.phase&&(c-=n.phase),void 0!==c&&0===a&&(r=c),c!=r+a&&(a&&(s+=b(r,t)),r=c,a=0,t=[]),n.lens){for(var d=0;d<n.lens.length;d++)t.push(n.lens[d]);a+=n.lens.length}}t.length&&(s+=b(r,t));var f=ASM.ENT||0,u=3+Math.floor(f/256)+Math.floor(f%256);return s+="S903"+g(f)+m(255-u%256)},srec28:function(e,o){for(var n,r=null,a=0,l=!1,t=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(n=e[i]).opcode&&1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(l=!0),!l||(o||(o="CSEG"),n.segment==o)){var c=n.addr;if(n.phase&&(c-=n.phase),void 0!==c&&0===a&&(r=c),c!=r+a&&(a&&(s+=P(r,t)),r=c,a=0,t=[]),n.lens){for(var d=0;d<n.lens.length;d++)t.push(n.lens[d]);a+=n.lens.length}}t.length&&(s+=P(r,t));var f=ASM.ENT||0,u=3+Math.floor(f/256)+Math.floor(f%256);return s+="S804"+v(f)+m(255-u%256)+"\n"},linemap:function(e){for(var o,n=[],r=null,a=0,l=e.length;a<l;a++)if(".PHASE"!==(o=e[a]).opcode||""===o.label)if(".DEPHASE"!==o.opcode){if(o.lens)for(var t=0;t<o.lens.length;t++)r?n[o.addr+t]?n[o.addr+t][r]=a+1:(n[o.addr+t]={},n[o.addr+t][r]=a+1):n[o.addr+t]=a+1}else r=null;else r=o.label;return n},beautify:function(o,n){e=n;var r=s(o.split(/\n/));r=t(r),r=l(r),r=a(r);var i=c(r,{noinclude:!0});r=r.map(function(e){return p(e,i[1])});for(var d,f,u="",h=0;h<r.length;h++)if(d=r[h],f="","EMPTYLINE"!=d.remark)if(d.label||d.opcode||!d.remark){for(d.label&&(f+=d.label,"EQU"!=d.opcode&&"="!=d.opcode&&".SET"!=d.opcode&&(f+=":"),f+=" ");f.length<12;)f+=" ";for(d.opcode&&(f+=d.opcode+" ");f.length<20;)f+=" ";d.params&&(f+=d.params+" "),d.remark&&(f+=";"+d.remark),u+=f+"\n"}else u+=";"+d.remark+"\n";else u+="\n";return u},buff:function(e){for(var o,n,r=new Uint8Array(65536),a=0,l=e.length;a<l;a++)if(o=e[a],n=o.addr,o.lens)for(var t=0;t<o.lens.length;t++)r[n++]=o.lens[t];return r},fileGet:function(e){o=e}}});