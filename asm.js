/*

Multitarget assembler (C) 2013 Martin Maly, http://www.maly.cz, http://www.webscript.cz

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.

 Parser is based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/

/* jshint browser:true, jquery:true */
/*global define, Uint8Array*/
/* eslint-disable no-empty */

var ASM = {};
  var Parser = require("./parser.js").Parser;
var btoa = require('btoa');
var atob = require('atob');
!function(e,n){"undefined"!=typeof module?(module.exports=n(),ASM=module.exports):"function"==typeof define&&"object"==typeof define.amd?define(n):this.ASM=n()}(0,function(){"use strict";var e=null,n=null,r={},o=!1,a=function(e,n){n=void 0===n||n;var r=e<0,o=r?-e:e;if(n&&e==Math.floor(e)&&e>=-65535&&e<=65535)return o=r?65536+e:e,[0,r?255:0,255&o,o>>8&255,0];var a=Math.floor(Math.log2(o)+1);if(a>127)throw new Error("Overflow");if(a<-127)return[0,0,0,0,0];var t;if(a<0)for(t=0;t<-a;t++)o*=2;else for(t=0;t<a;t++)o/=2;var l=function(e,n){for(var r="",o=[],a=0;a<32;a++){var t="0";(e*=2)>=1&&(e-=1,t="1"),n&&0===a&&(t="1"),n||0!==a||(t="0"),r+=t,a%8==7&&(o.push(parseInt(r,2)),r="")}return o}(o,r);return[a+128,l[0],l[1],l[2],l[3]]},t=function(e){return e.map(function(e){var n=e.line;for(n=(n=n.replace("&lt;","<")).replace("&gt;",">");" "==n[n.length-1];)n=n.substr(0,n.length-1);if(e.line=n," "!=n[0])return e;for(;" "==n[0];)n=n.substr(1);return e.line=" "+n,e})},l=function(e){return e.filter(function(e){for(var n=e.line;" "==n[0];)n=n.substr(1);return!!n.length})},s=function(e){return e.map(function(e){for(var n=e.line,r={addr:0,line:";;;EMPTYLINE",numline:e.numline};" "==n[0];)n=n.substr(1);return n.length?e:r})},i=function(e){var n=1;return e.map(function(e){return{line:e,numline:n++,addr:null,bytes:0}})},p=function(e){return e.replace(/^\s+|\s+$/g,"")},f=function(n,r,o,a){var t=n.line,l=t.match(/^\s*(\@{0,1}[a-zA-Z0-9-_]+):\s*(.*)/);l&&(n.label=l[1].toUpperCase(),t=l[2]),n._dp=0,n.params=[];var s=t.match(/^\s*(\=)\s*(.*)/);if(s?(n.opcode=s[1].toUpperCase(),t=s[2]):(s=t.match(/^\s*([\.a-zA-Z0-9-_]+)\s*(.*)/))&&(n.opcode=s[1].toUpperCase(),t=s[2]),t){for(;t.match(/\"(.*?)\"/g);)t=t.replace(/\"(.*?)\"/g,function(e){return"00ss"+btoa(e)+"!"});for(;t.match(/\'(.*?)\'/g);)t=t.replace(/\'(.*?)\'/g,function(e){return"00ss"+btoa('"'+e.substr(1,e.length-2)+'"')+"!"});for(;t.match(/\{(.*?)\}/g);)t=t.replace(/\{(.*?)\}/g,function(e){return"00bb"+btoa(e.substr(1,e.length-2))});for(;t.match(/"(.*?);(.*?)"/g);)t=t.replace(/"(.*?);(.*?)"/g,'"$1§$2"');for(;t.match(/'(.*?);(.*?)'/g);)t=t.replace(/'(.*?);(.*?)'/g,'"$1§$2"');var i=t.match(/^\s*([^;]*)(.*)/);if(i&&i[1].length){n.paramstring=i[1];for(var c=i[1];c.match(/"(.*?),(.*?)"/g);)c=c.replace(/"(.*?),(.*?)"/g,'"$1€$2"');for(;c.match(/'(.*?),(.*?)'/g);)c=c.replace(/'(.*?),(.*?)'/g,'"$1€$2"');var d=c.match(/([0-9]+)\s*DUP\s*\((.*)\)/i);if(d){for(var u=parseInt(d[1]),h="",m=0;m<u;m++)h+=d[2]+",";c=h.substring(0,h.length-1)}var g=c.split(/\s*,\s*/);n.params=g.map(function(e){var n=p(e.replace(/€/g,",").replace(/§/g,";"));return n=n.replace(/00ss(.*?)\!/g,function(e){return atob(e.substr(4,e.length-5))})}),t=i[2].replace(/§/g,";")}}if(t){var v=t.match(/^\s*;*(.*)/);v&&(n.remark=v[1].replace(/00ss(.*?)\!/g,function(e){return atob(e.substr(4,e.length-5))}),n.remark||(n.remark=" "),t="")}if(n.notparsed=t,"ORG"===n.opcode&&(n.opcode=".ORG"),".ERROR"===n.opcode)throw{msg:n.paramstring,s:n};if(".EQU"===n.opcode&&(n.opcode="EQU"),".FILL"===n.opcode&&(n.opcode="FILL"),".ORG"===n.opcode)try{return n}catch(e){throw{msg:e.message,s:n}}if("DEFB"===n.opcode)return n.opcode="DB",n;if(".BYTE"===n.opcode)return n.opcode="DB",n;if(".DB"===n.opcode)return n.opcode="DB",n;if(".WORD"===n.opcode)return n.opcode="DW",n;if(".DW"===n.opcode)return n.opcode="DW",n;if("DEFW"===n.opcode)return n.opcode="DW",n;if(".DD"===n.opcode)return n.opcode="DD",n;if(".DF"===n.opcode)return n.opcode="DF",n;if(".DFZXS"===n.opcode)return n.opcode="DFZXS",n;if(".DFF"===n.opcode)return n.opcode="DFF",n;if("DEFS"===n.opcode)return n.opcode="DS",n;if(".RES"===n.opcode)return n.opcode="DS",n;if("DEFM"===n.opcode)return n.opcode="DS",n;if(".ALIGN"===n.opcode)return n.opcode="ALIGN",n;if(".IF"===n.opcode)return n.opcode="IF",n;if(".ELSE"===n.opcode)return n.opcode="ELSE",n;if(".ENDIF"===n.opcode)return n.opcode="ENDIF",n;if(".PRAGMA"===n.opcode)return ASM.PRAGMAS=ASM.PRAGMAS||[],ASM.PRAGMAS.push(n.params[0].toUpperCase()),n;if("EQU"===n.opcode||"="===n.opcode||".SET"===n.opcode||"IF"===n.opcode||"IFN"===n.opcode||"ELSE"===n.opcode||"ENDIF"===n.opcode||".INCLUDE"===n.opcode||".INCBIN"===n.opcode||".MACRO"===n.opcode||".ENDM"===n.opcode||".BLOCK"===n.opcode||".ENDBLOCK"===n.opcode||".REPT"===n.opcode||".CPU"===n.opcode||".ENT"===n.opcode||".BINFROM"===n.opcode||".BINTO"===n.opcode||".ENGINE"===n.opcode||".PRAGMA"===n.opcode||"END"===n.opcode||".END"===n.opcode||"BSZ"===n.opcode||"FCB"===n.opcode||"FCC"===n.opcode||"FDB"===n.opcode||"FILL"===n.opcode||"RMB"===n.opcode||"ZMB"===n.opcode||"SETDP"===n.opcode||".M8"===n.opcode||".X8"===n.opcode||".M16"===n.opcode||".X16"===n.opcode||".PHASE"===n.opcode||".DEPHASE"===n.opcode||".SETPHASE"===n.opcode||"ALIGN"===n.opcode||".CSTR"===n.opcode||".ISTR"===n.opcode||".PSTR"===n.opcode||".CSEG"===n.opcode||".DSEG"===n.opcode||".ESEG"===n.opcode||".BSSEG"===n.opcode||"DB"===n.opcode||"DW"===n.opcode||"DD"===n.opcode||"DF"===n.opcode||"DFF"===n.opcode||"DFZXS"===n.opcode||"DS"===n.opcode)return n;if(".DEBUGINFO"===n.opcode||".MACPACK"===n.opcode||".FEATURE"===n.opcode||".ZEROPAGE"===n.opcode||".SEGMENT"===n.opcode||".SETCPU"===n.opcode)return n.opcode="",n;if(!n.opcode&&n.label)return n;try{var b=e.parseOpcode(n)}catch(e){throw{msg:e,s:n}}if(null!==b)return b;if(r[n.opcode])return n.macro=n.opcode,n;if(!n.label&&!o){var E={line:n.line,numline:n.numline,addr:null,bytes:0};if(n.remark&&!n.opcode)return n;if(!n.params||0===n.params.length)throw{msg:"Unrecognized instruction "+n.opcode,s:n};if(!n.opcode)throw{msg:"Unrecognized instruction "+n.opcode,s:n};0===n.params[0].indexOf(":=")&&(n.params[0]=n.params[0].substr(1)),E.line=n.opcode+": "+n.params.join(),n.remark&&(E.line+=" ;"+n.remark);var S=f(E,r,!0,n);if(!S.opcode)throw{msg:"Unrecognized instruction "+n.opcode,s:n};return S}if(o)throw{msg:"Unrecognized instruction "+a.opcode,s:n};throw{msg:"Unrecognized instruction "+n.opcode,s:n}},c=function(e,n){if(!n)return e;for(var r=[],o=null,a=0;a<e.length;a++){var t=e[a],l=f(t,{});if(o&&r.push(t),".ENDBLOCK"==l.opcode){if(o)return r}else if(".BLOCK"==l.opcode){if(o)return r;l.params[0].toUpperCase()==n.toUpperCase()&&(r.push(t),o=!0)}}throw{msg:"Cannot find block "+n+" in included file"}},d=function(e,o,a){var s,f,u=null;o=o||{};for(var h={},m=null,g=null,v=[],b=0,E=e.length;b<E;b++)if(s=e[b].line,f=s.match(/\s*(\.[^\s]+)(.*)/)){var S=f[1].toUpperCase(),A=f[2].match(/^\s*([^;]*)(.*)/);if(A&&A[1].length?(A[1],u=(R=A[1].split(/\s*,\s*/)).map(p)):u=null,".INCLUDE"!==S||!o.noinclude)if(".INCLUDE"!==S)if(".ENDM"!==S)if(".MACRO"!==S)if(".REPT"!==S)m?h[m].push(e[b]):v.push(e[b]);else{if(!u[0])throw{msg:"No repeat count given",s:e[b]};if(!(g=Parser.evaluate(u[0])))throw{msg:"Bad repeat count given",s:e[b]};if(m="*REPT"+e[b].numline,h[m])throw{msg:"Macro redefinition at line "+e[b].numline,s:e[b]};h[m]=[]}else{if(";"===s[0])continue;var M=null,y=s.match(/^(\S*)\s+\.MACRO/i);if(y?M=y[1]:u&&u[0]&&(M=u.shift()),!M)throw{msg:"Bad macro name at line "+e[b].numline,s:e[b]};if(":"===M[M.length-1]&&(M=M.substr(0,M.length-1)),m=M.toUpperCase(),h[m])throw{msg:"Macro "+m+" redefinition at line "+e[b].numline,s:e[b]};h[m]=[u]}else{if(!m)throw{msg:"ENDM without MACRO at line "+e[b].numline,s:e[b]};if(g){v.push({numline:e[b].numline,line:";rept unroll",addr:null,bytes:0,remark:"REPT unroll"});for(var C=0;C<g;C++)for(var D=0;D<h[m].length;D++){var P=h[m][D].line;v.push({numline:e[C].numline,line:P,addr:null,bytes:0})}}else{var N=h[m][0];v.push({numline:e[b].numline,line:";Macro define "+m,addr:null,bytes:0,listing:".macro "+m+(N?",":"")+N.join(",")});for(var F=h[m],I=0;I<F.length;I++)v.push({line:";",listing:F[I].line});v.push({line:";",listing:".endm"}),v.push({line:";",listing:" "})}m=null,g=null}else{var w="";if(u[0].indexOf(":")>=0){var R=u[0].split(":");if(u[0]=R[0],w=R[1],3==R.length)w=R[2];else if(r["*"+R[0].toUpperCase()+":"+w.toUpperCase()])continue;r["*"+R[0].toUpperCase()+":"+w.toUpperCase()]="used"}if(!u||!u[0])throw{msg:"No file name given",s:e[b]};if("THIS"==u[0].toUpperCase()&&w)G=c(a,w);else{var B=n(u[0].replace(/\"/g,""));if(!B)throw{msg:"File "+u[0]+" not found",s:e[b]};var G=i(B.split(/\n/));G=l(G);var T=G=t(G);G=c(G,w)}for(var U=d(G,{},T),I=0;I<U[0].length;I++)U[0][I].includedFile=u[0].replace(/\"/g,""),v.push(U[0][I]);for(I in U[1])h[I]=U[1][I];r[u[0].replace(/\"/g,"")]=B}}else{if(m){h[m].push(e[b]);continue}v.push(e[b])}if(m)throw{msg:"MACRO "+m+" has no appropriate ENDM",s:e[b]};return[v,h]},u=function(e,n,r,o,a){var t={line:e.line,addr:e.addr,macro:e.macro,numline:e.numline};n=n||[];var l=o||[];if(l&&l.length>n.length)throw t.numline=a,{msg:"Too few parameters for macro unrolling",s:t};for(var s=n.length-1;s>=0;s--){var i=n[s];0===i.indexOf("00bb")&&(i=atob(i.substr(4))),t.line=t.line.replace("%%"+(s+1),i),l&&l[s]&&(t.line=t.line.replace(l[s],i))}return t.line=t.line.replace("%%M","M_"+r),t.line=t.line.replace("%%m","M_"+r),t},h=function(e,n){for(var r=[],o=0;o<e.length;o++){var a=e[o];if(a.macro){var t=n[a.macro],l=t[0];r.push({remark:"*Macro unroll: "+a.line});for(var s=0;s<t.length;s++)if(0!==s){var i=u(t[s],a.params,o,l,a.numline);i.bytes=0;var p=f(i,n);if(p.macro)for(var c=h([p],n),d=0;d<c.length;d++)r.push(c[d]);else a.label&&(p.label=a.label),a.label="",p.remark=a.remark,p.macro=a.macro,a.macro=null,a.remark="",r.push(p)}}else r.push(a)}return r},m={},g=function(e,n){for(var r=e.toString(16);r.length<n;)r="0"+r;return r.toUpperCase()},v=function(e){return g(255&e,2)},b=function(e){return g(e,4)},E=function(e){return g(e,6)},S=function(e){if(ASM.PRAGMAS.RELAX)return"string"==typeof e?255&e.charCodeAt(0):255&e;if("string"==typeof e){if(1!=e.length)throw"String parameter too long ("+e+")";return 255&e.charCodeAt(0)}if(e>255)throw"Param out of bound ("+e+")";if(e<-128)throw"Param out of bound ("+e+")";return 255&e},A=function(e,n){var r=":",o=n.length,a=0;r+=v(o),r+=b(e),r+="00",a=o+Math.floor(e/256)+Math.floor(e%256);for(var t=0;t<n.length;t++)r+=v(n[t]),a+=n[t];return r+=v(256-a%256)},M=function(e,n,r){var o=0,a=[],t=16;r>1&&(t=r);for(var l="",s=0;s<n.length;s++)a.push(n[s]),++o===t&&(l+=A(e,a)+"\n",a=[],o=0,e+=t);return a.length&&(l+=A(e,a)+"\n"),l},y=function(e,n){var r="S1",o=n.length,a=0;r+=v(o+3),r+=b(e),a=o+3+Math.floor(e/256)+Math.floor(e%256);for(var t=0;t<n.length;t++)r+=v(n[t]),a+=n[t];return r+=v(256-a%256)},C=function(e,n){for(var r=0,o=[],a="",t=0;t<n.length;t++)o.push(n[t]),16==++r&&(a+=y(e,o)+"\n",o=[],r=0,e+=16);return o.length&&(a+=y(e,o)+"\n"),a},D=function(e,n){var r="S2",o=n.length,a=0;r+=v(o+4),r+=E(e),a=o+4+Math.floor(e/65536)+Math.floor(e/256)%256+Math.floor(e%256);for(var t=0;t<n.length;t++)r+=v(n[t]),a+=n[t];return r+=v(255-a%256)},P=function(e,n){for(var r=0,o=[],a="",t=0;t<n.length;t++)o.push(n[t]),16==++r&&(a+=D(e,o)+"\n",o=[],r=0,e+=16);return o.length&&(a+=D(e,o)+"\n"),a};return{parse:function(n,a){e=a,a.endian&&(o=a.endian),r={};var s=i(n.split(/\n/));s=l(s),s=t(s);var p=d(s);return s=p[0].map(function(e){return f(e,p[1])}),s=h(s,p[1])},pass1:function(r,o){var a="CSEG",t=function(){if("BSSEG"===a)throw d.opcode+" is not allowed in BSSEG"},l={},s=0,i={};o&&(i=o);for(var p,f,c,d=null,u=0,h=0,g=[],v=[],b=0,E=0,S=0,A=r.length;S<A;S++)if(d=r[S],ASM.WLINE=r[S],d.pass=1,d.segment=a,d.addr=s,d._dp=E,i._PC=s,0!==b&&(d.phase=b),"ENDIF"!==d.opcode)if("ELSE"!==d.opcode)if("IF"!==d.opcode)if("IFN"!==d.opcode)if(u)d.ifskip=!0;else if(".BLOCK"!==d.opcode)if(".ENDBLOCK"!==d.opcode){if(d.label){var M=d.label,y=!1;if("@"===M[0]&&(y=!0,M=M.substr(1),d.label=M,d.beGlobal=!0),d.beGlobal&&(y=!0),v.length>0&&(M=v.join("/")+"/"+M,i["__"+v.join("/")].push(d.label)),!o&&(i[M+"$"]||y&&void 0!==i[d.label]))throw{msg:"Redefine label "+d.label+" at line "+d.numline,s:d};i[d.label]?i[M]=i[d.label]:y&&(i[M]=s),m[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:s},i[M+"$"]=s,i[d.label]=s,y&&(i[M]=s)}try{if(".ORG"===d.opcode){s=Parser.evaluate(d.params[0],i),d.addr=s,l[a]=s;continue}if(".CSEG"===d.opcode&&(l[a]=s,a="CSEG",d.segment=a,s=l[a]||0,d.addr=s),".DSEG"===d.opcode&&(l[a]=s,a="DSEG",d.segment=a,s=l[a]||0,d.addr=s),".ESEG"===d.opcode&&(l[a]=s,a="ESEG",d.segment=a,s=l[a]||0,d.addr=s),".BSSEG"===d.opcode&&(l[a]=s,a="BSSEG",d.segment=a,s=l[a]||0,d.addr=s),".PHASE"===d.opcode){if(b)throw{message:"PHASE cannot be nested"};var C=Parser.evaluate(d.params[0],i);d.addr=s,b=C-s,s=C;continue}if(".DEPHASE"===d.opcode){d.addr=s,s-=b,b=0;continue}if("EQU"===d.opcode||".SET"===d.opcode){try{i[d.label]=Parser.evaluate(d.params[0],i)}catch(e){i[d.label]=null}m[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:i[d.label]};continue}if("="===d.opcode||":="===d.opcode){i[d.label]=Parser.evaluate(d.params[0],i),m[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:i[d.label]};continue}}catch(e){throw{msg:e.message,s:d}}if("DB"===d.opcode||"FCB"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes++;continue}if("string"==typeof p){d.bytes+=p.length;continue}}catch(e){d.bytes++}if("FCC"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++){var D=d.params[f].trim(),P=D[0];if(D[D.length-1]!==P)throw{msg:"Delimiters does not match",s:d};d.bytes+=D.length-2}if(".CSTR"===d.opcode||".PSTR"===d.opcode||".ISTR"===d.opcode){for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes++;continue}if("string"==typeof p){d.bytes+=p.length;continue}}catch(e){d.bytes++}".CSTR"!==d.opcode&&".PSTR"!==d.opcode||d.bytes++}if("DS"!==d.opcode&&"RMB"!==d.opcode)if("ALIGN"!==d.opcode)if("SETDP"!==d.opcode)if("FILL"!==d.opcode)if("BSZ"!==d.opcode&&"ZMB"!==d.opcode){if("DW"===d.opcode||"FDB"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes+=2;continue}}catch(e){d.bytes+=2}if("DD"===d.opcode||"DF"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes+=4;continue}}catch(e){d.bytes+=4}if("DFF"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes+=8;continue}}catch(e){d.bytes+=8}if("DFZXS"===d.opcode)for(t(),d.bytes=0,f=0;f<d.params.length;f++)try{if("number"==typeof(p=Parser.evaluate(d.params[f],i))){d.bytes+=5;continue}}catch(e){d.bytes+=5}if(".INCBIN"!==d.opcode)if(".M16"!==d.opcode)if(".M8"!==d.opcode)if(".X16"!==d.opcode)if(".X8"!==d.opcode){var N=e.parseOpcode(r[S],i);N&&(t(),d=N),void 0===d.bytes&&(d.bytes=0),s+=d.bytes}else i.__MX=8;else i.__MX=16;else i.__AX=8;else i.__AX=16;else{if(t(),!d.params[0])throw{msg:"No file name given at line "+d.numline,s:d};var F=n(d.params[0],!0);if(!F)throw{msg:"Cannot find file "+d.params[0]+" for incbin",s:d};for(d.bytes=0,d.lens=[],B=0;B<F.length;B++){var I=F.charCodeAt(B);I>255&&(d.lens[d.bytes++]=I>>8),d.lens[d.bytes++]=I%256}s+=d.bytes}}else{for(t(),w=Parser.evaluate(d.params[0],i),d.bytes=w,d.lens=[],B=0;B<w;B++)d.lens[B]=0;s+=w}else{t();var w=Parser.evaluate(d.params[1],i);for("string"==typeof(p=Parser.evaluate(d.params[0],i))&&(p=p.charCodeAt(0)),d.bytes=w,d.lens=[],B=0;B<w;B++)d.lens[B]=p;s+=w}else E=Parser.evaluate(d.params[0],i);else{var R=Parser.evaluate(d.params[0],i);s+=s%R>0?R-s%R:0}else{if("number"!=typeof(w=Parser.evaluate(d.params[0],i)))throw{msg:"DS / RMB needs a numerical parameter",s:d};if(2==d.params.length){"string"==typeof(p=Parser.evaluate(d.params[1],i))&&(p=p.charCodeAt(0)),d.bytes=w,d.lens=[];for(var B=0;B<w;B++)d.lens[B]=p}s+=w}}else{for(var G=i["__"+v.join("/")],T=0;T<G.length;T++)i[G[T]]=i[v.join("/")+"/"+G[T]],delete i[v.join("/")+"/"+G[T]];v.pop(),i.__blocks=JSON.stringify(v)}else{v.push(d.numline);var U=v.join("/");i["__"+U]=[]}else{try{c=Parser.evaluate(d.params[0],i)}catch(e){}c&&(u=1),h=1,g.push(u)}else{try{c=Parser.evaluate(d.params[0],i)}catch(e){}c||(u=1),h=1,g.push(u)}else{if(!h)throw{msg:"ELSE without IF",s:d};u=(u=g.pop())?0:1,g.filter(function(e){return 1==e}).length&&(u=1),g.push(u)}else{if(!h)throw{msg:"ENDIF without IF",s:d};u=g.pop(),g.length?h=1:(h=0,u=0)}return[r,i]},pass2:function(e){for(var n,r,t=e[0],l=e[1],s=null,i=null,p=[],f=0,c=0,d=t.length;c<d;c++)try{if(s=t[c],s.pass=2,"ENDIF"===s.opcode){f=0;continue}if("ELSE"===s.opcode){f=f?0:1;continue}if(f)continue;if("IF"===s.opcode){Parser.evaluate(s.params[0],l);try{Parser.evaluate(s.params[0],l)||(f=1)}catch(e){throw{message:"IF condition mismatched"}}continue}if("IFN"===s.opcode){try{Parser.evaluate(s.params[0],l)&&(f=1)}catch(e){throw{message:"IF condition mismatched"}}continue}l._PC=s.addr;try{for(var u=Parser.usage(s.params[0].toUpperCase(),l),h=0;h<u.length;h++)m[u[h]].usage||(m[u[h]].usage=[]),m[u[h]].usage.push({line:s.numline,file:s.includedFile||"*main*"})}catch(e){}try{for(var u=Parser.usage(s.params[1].toUpperCase(),l),h=0;h<u.length;h++)m[u[h]].usage||(m[u[h]].usage=[]),m[u[h]].usage.push({line:s.numline,file:s.includedFile||"*main*"})}catch(e){}if(".BLOCK"===s.opcode){p.push(s.numline);for(var g=l["__"+p.join("/")],v=0;v<g.length;v++)l[p.join("/")+"/"+g[v]]=l[g[v]],l[g[v]]=l[p.join("/")+"/"+g[v]+"$"];continue}if(".ENDBLOCK"===s.opcode){for(var g=l["__"+p.join("/")],v=0;v<g.length;v++)l[g[v]]=l[p.join("/")+"/"+g[v]],void 0===l[g[v]]&&delete l[g[v]],l[p.join("/")+"/"+g[v]]=null;p.pop();continue}if(".ENT"===s.opcode){ASM.ENT=Parser.evaluate(s.params[0],l);continue}if(".BINFROM"===s.opcode){ASM.BINFROM=Parser.evaluate(s.params[0],l);continue}if(".BINTO"===s.opcode){ASM.BINTO=Parser.evaluate(s.params[0],l);continue}if(".SETPHASE"===s.opcode){ASM.PHASES||(ASM.PHASES={}),ASM.PHASES[s.addr]=s.params[0];continue}if(".ENGINE"===s.opcode){ASM.ENGINE=s.params[0];continue}if("EQU"===s.opcode){if(!s.label)throw{msg:"EQU without label",s:s};l[s.label]=Parser.evaluate(s.params[0],l);continue}if(".SET"===s.opcode){l[s.label]=Parser.evaluate(s.params[0],l);continue}if("DB"===s.opcode||"FCB"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)))if("string"!=typeof E);else for(A=0;A<E.length;A++)s.lens[n++]=E.charCodeAt(A);else s.lens[n++]=Math.floor(E%256);continue}if("FCC"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)for(var b=s.params[r].trim(),E=(b[0],b.substr(1,b.length-2)),A=0;A<E.length;A++)s.lens[n++]=E.charCodeAt(A);continue}if(".CSTR"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)))if("string"!=typeof E);else for(A=0;A<E.length;A++)s.lens[n++]=E.charCodeAt(A);else s.lens[n++]=Math.floor(E%256);s.lens[n++]=0;continue}if(".PSTR"===s.opcode){for(n=1,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)))if("string"!=typeof E);else for(A=0;A<E.length;A++)s.lens[n++]=E.charCodeAt(A);else s.lens[n++]=Math.floor(E%256);s.lens[0]=n-1;continue}if(".ISTR"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)))if("string"!=typeof E);else for(A=0;A<E.length;A++)s.lens[n++]=127&E.charCodeAt(A);else s.lens[n++]=Math.floor(E%128);s.lens[n-1]=128|s.lens[n-1];continue}if("DW"===s.opcode||"FDB"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)"number"!=typeof(E=Parser.evaluate(s.params[r],l))||(o?(s.lens[n++]=Math.floor(E/256),s.lens[n++]=Math.floor(E%256)):(s.lens[n++]=Math.floor(E%256),s.lens[n++]=Math.floor(E/256)));continue}if("DD"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)"number"!=typeof(E=Parser.evaluate(s.params[r],l))||(M=new ArrayBuffer(4),(y=new Int32Array(M))[0]=E,C=new Uint8Array(M),o?(s.lens[n++]=C[3],s.lens[n++]=C[2],s.lens[n++]=C[1],s.lens[n++]=C[0]):(s.lens[n++]=C[0],s.lens[n++]=C[1],s.lens[n++]=C[2],s.lens[n++]=C[3]));continue}if("DF"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)"number"!=typeof(E=Parser.evaluate(s.params[r],l))||(M=new ArrayBuffer(4),(y=new Float32Array(M))[0]=E,C=new Uint8Array(M),o?(s.lens[n++]=C[3],s.lens[n++]=C[2],s.lens[n++]=C[1],s.lens[n++]=C[0]):(s.lens[n++]=C[0],s.lens[n++]=C[1],s.lens[n++]=C[2],s.lens[n++]=C[3]));continue}if("DFF"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)));else{var M=new ArrayBuffer(8),y=new Float64Array(M);y[0]=E,C=new Uint8Array(M),o?(s.lens[n++]=C[7],s.lens[n++]=C[6],s.lens[n++]=C[5],s.lens[n++]=C[4],s.lens[n++]=C[3],s.lens[n++]=C[2],s.lens[n++]=C[1],s.lens[n++]=C[0]):(s.lens[n++]=C[0],s.lens[n++]=C[1],s.lens[n++]=C[2],s.lens[n++]=C[3],s.lens[n++]=C[4],s.lens[n++]=C[5],s.lens[n++]=C[6],s.lens[n++]=C[7])}continue}if("DFZXS"===s.opcode){for(n=0,s.lens=[],r=0;r<s.params.length;r++)if("number"!=typeof(E=Parser.evaluate(s.params[r],l)));else{var C=a(E,!1);o?(s.lens[n++]=C[4],s.lens[n++]=C[3],s.lens[n++]=C[2],s.lens[n++]=C[1],s.lens[n++]=C[0]):(s.lens[n++]=C[0],s.lens[n++]=C[1],s.lens[n++]=C[2],s.lens[n++]=C[3],s.lens[n++]=C[4])}continue}if(s.lens&&s.lens[1]&&"function"==typeof s.lens[1]&&("addr24"===s.lens[2]?(i=s.lens[1](l),o?(s.lens[3]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[1]=Math.floor(i>>16&255)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[3]=Math.floor(i>>16&255))):"addr32"===s.lens[2]?(i=s.lens[1](l),o?(s.lens[4]=Math.floor(i%256),s.lens[3]=Math.floor((i>>8)%256),s.lens[2]=Math.floor(i>>16&255),s.lens[1]=Math.floor(i>>24&255)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor((i>>8)%256),s.lens[3]=Math.floor(i>>16&255),s.lens[4]=Math.floor(i>>24&255))):null===s.lens[2]?"string"==typeof(i=s.lens[1](l))?o?(s.lens[1]=255&i.charCodeAt(0),s.lens[2]=255&i.charCodeAt(1)):(s.lens[2]=255&i.charCodeAt(0),s.lens[1]=255&i.charCodeAt(1)):o?(s.lens[2]=Math.floor(i%256),s.lens[1]=Math.floor(i/256)):(s.lens[1]=Math.floor(i%256),s.lens[2]=Math.floor(i/256)):(i=s.lens[1](l),s.lens[1]=S(i))),s.lens&&s.lens.length>2&&"function"==typeof s.lens[2]&&(i=s.lens[2](l),null===s.lens[3]?"string"==typeof(i=s.lens[2](l))?o?(s.lens[2]=255&i.charCodeAt(0),s.lens[3]=255&i.charCodeAt(1)):(s.lens[3]=255&i.charCodeAt(0),s.lens[2]=255&i.charCodeAt(1)):o?(s.lens[3]=255&i,s.lens[2]=i>>8):(s.lens[2]=255&i,s.lens[3]=i>>8):s.lens[2]=S(i)),s.lens&&s.lens.length>3&&"function"==typeof s.lens[3]&&(i=s.lens[3](l),null===s.lens[4]?"string"==typeof(i=s.lens[3](l))?o?(s.lens[3]=255&i.charCodeAt(0),s.lens[4]=255&i.charCodeAt(1)):(s.lens[4]=255&i.charCodeAt(0),s.lens[3]=255&i.charCodeAt(1)):o?(s.lens[4]=255&i,s.lens[3]=i>>8):(s.lens[3]=255&i,s.lens[4]=i>>8):s.lens[3]=S(i)),s.lens&&s.lens.length>1){if("string"==typeof s.lens[1]&&(s.lens[1]=s.lens[1].charCodeAt(0)),isNaN(s.lens[1]))throw{message:"param out of bounds, NaN"};if((s.lens[1]>255||s.lens[1]<-128)&&2==s.lens.length)throw{message:"param out of bounds - "+s.lens[1]};s.lens[1]<0&&(s.lens[1]=256+s.lens[1])}}catch(e){throw{msg:e.message,s:s,e:e}}return[t,l]},parseLine:f,ENT:null,WLINE:null,compile:function(e,n){try{ASM.ENT=null,ASM.BINFROM=null,ASM.BINTO=null,ASM.ENGINE=null,ASM.PRAGMAS=[];var r=ASM.parse(e,n);m={};var o=ASM.pass1(r);return o=ASM.pass1(o[0],o[1]),o=ASM.pass1(o[0],o[1]),o=ASM.pass1(o[0],o[1]),o=ASM.pass1(o[0],o[1]),o=ASM.pass1(o[0],o[1]),o=ASM.pass1(o[0],o[1]),o[1].__PRAGMAS=ASM.PRAGMAS,o=ASM.pass2(o),[null,o,m]}catch(e){console.log(e);var a=e.s||"Internal error";return e.e&&(e="object"==typeof e.e?e.e:{msg:e.e,s:e.s}),!e.msg&&e.message&&(e.msg=e.message),e.msg?(e.s||(e.s=a),[e,null]):["Cannot evaluate line "+ASM.WLINE.numline+", there is some unspecified error (e.g. reserved world as label etc.)",null]}},compileAsync:function(e,n,r){try{var o=ASM.parse(e,n),a=ASM.pass1(o);a=ASM.pass2(a),r(null,a)}catch(e){r(e,null)}},lst:function(e,n,r,o,a){var t,l,s="";void 0===o&&(o=!1);for(var i=0,p=e.length;i<p;i++){if(l=e[i],t="",l.macro,void 0===l.addr||l.ifskip||(t+=b(l.addr),l.phase&&(t+=" @"+b(l.addr-l.phase)),t+=o?" ":"   "),l.lens&&!l.ifskip)for(var f=0;f<l.lens.length;f++)t+=v(l.lens[f])+" ";if(!o)for(;t.length<20;)t+=" ";if(o)for(;t.length<15;)t+=" ";if(l.listing)s+=t+l.listing+"\n";else{if(l.label&&(t+=l.label+":   "),!o)for(;t.length<30;)t+=" ";if(o)for(;t.length<22;)t+=" ";l.opcode&&(t+=l.opcode+(o?" ":"   ")),l.bandPar&&(t+=l.bandPar+","),l.aimPar&&(t+=l.aimPar+","),l.params&&(t+=l.params+(o?" ":"   ")),l.remark&&(t+=";"+l.remark),s+=t+"\n"}}if(r)return s;s+="\n\n";for(var c in m)if(null!==m[c]&&("_"!=c[0]||"_"!=c[1])&&"$"!==c[c.length-1]){for(t="",t+=c+": ";t.length<20;)t+=" ";if(t+=b(m[c].value),t+=" DEFINED AT LINE "+m[c].defined.line,"*main*"!=m[c].defined.file&&(t+=" IN "+m[c].defined.file),s+=t+"\n",m[c].usage)for(p=0;p<m[c].usage.length;p++)s+="                    > USED AT LINE "+m[c].usage[p].line,"*main*"!=m[c].usage[p].file&&(s+=" IN "+m[c].usage[p].file),s+="\n"}return s},html:function(e,n,r,o){var a,t,l="<html><head><meta charset=utf-8><body><table>";void 0===o&&(o=!1);for(var s=0,i=e.length;s<i;s++){if(t=e[s],a='<tr id="ln'+t.numline+'">',t.macro,void 0!==t.addr?(a+='<td><a name="ADDR'+b(t.addr)+'">'+b(t.addr)+"</a>",t.phase?a+="</td><td>"+b(t.addr-t.phase):a+="</td><td>",a+="</td>"):a+="<td></td><td></td>",t.lens){a+="<td>";for(var p=0;p<t.lens.length;p++)a+=v(t.lens[p])+" ";a+="</td>"}else a+="<td></td>";t.label?a+='<td><a name="LBL'+t.label+'">'+t.label+"</a></td>":a+="<td></td>",t.opcode?a+="<td>"+t.opcode+"</td>":a+="<td></td>",t.params?a+="<td>"+t.params.map(function(e){e+="";for(var r in n)if(null!==n[r]&&("_"!=r[0]||"_"!=r[1])&&"$"!==r[r.length-1]){var o=new RegExp("^"+r+"$","i");if(e.match(o))return'<a href="#LBL'+r+'">'+e+"</a>"}return e})+"</td>":a+="<td></td>",t.remark?a+="<td>;"+t.remark+"</td>":a+="<td></td>",l+=a+"</tr>\n"}return l+="</table>"},hex:function(e,n){for(var r,o=null,a=0,t=[],l="",s=!1,i=16,p=0,f=e.length;p<f;p++)if(".PRAGMA"===(r=e[p]).opcode&&(2==r.params.length&&"HEXLEN"==r.params[0].toUpperCase()&&((i=parseInt(r.params[1]))<1||i>64)&&(i=16),1==r.params.length&&"SEGMENT"==r.params[0].toUpperCase()&&(s=!0)),!(r.ifskip||s&&(n||(n="CSEG"),r.segment!=n))){var c=r.addr;if(r.phase&&(c-=r.phase),void 0!==c&&0===a&&(o=c),c!=o+a&&(a&&(l+=M(o,t,i)),o=c,a=0,t=[]),r.lens){for(var d=0;d<r.lens.length;d++)t.push(r.lens[d]);a+=r.lens.length}}return t.length&&(l+=M(o,t,i)),l+=":00000001FF"},srec:function(e,n){for(var r,o=null,a=0,t=!1,l=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(r=e[i]).opcode&&1==r.params.length&&"SEGMENT"==r.params[0].toUpperCase()&&(t=!0),!(r.ifskip||t&&(n||(n="CSEG"),r.segment!=n))){var f=r.addr;if(r.phase&&(f-=r.phase),void 0!==f&&0===a&&(o=f),f!=o+a&&(a&&(s+=C(o,l)),o=f,a=0,l=[]),r.lens){for(var c=0;c<r.lens.length;c++)l.push(r.lens[c]);a+=r.lens.length}}l.length&&(s+=C(o,l));var d=ASM.ENT||0,u=3+Math.floor(d/256)+Math.floor(d%256);return s+="S903"+b(d)+v(255-u%256)},srec28:function(e,n){for(var r,o=null,a=0,t=!1,l=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(r=e[i]).opcode&&1==r.params.length&&"SEGMENT"==r.params[0].toUpperCase()&&(t=!0),!t||(n||(n="CSEG"),r.segment==n)){var f=r.addr;if(r.phase&&(f-=r.phase),void 0!==f&&0===a&&(o=f),f!=o+a&&(a&&(s+=P(o,l)),o=f,a=0,l=[]),r.lens){for(var c=0;c<r.lens.length;c++)l.push(r.lens[c]);a+=r.lens.length}}l.length&&(s+=P(o,l));var d=ASM.ENT||0,u=3+Math.floor(d/256)+Math.floor(d%256);return s+="S804"+E(d)+v(255-u%256)+"\n"},linemap:function(e){for(var n,r=[],o=null,a=0,t=e.length;a<t;a++)if(".PHASE"!==(n=e[a]).opcode||""===n.label)if(".DEPHASE"!==n.opcode){if(n.lens)for(var l=0;l<n.lens.length;l++)o?r[n.addr+l]?r[n.addr+l][o]=a+1:(r[n.addr+l]={},r[n.addr+l][o]=a+1):r[n.addr+l]=a+1}else o=null;else o=n.label;return r},beautify:function(n,r){e=r;var o=i(n.split(/\n/));o=s(o),o=l(o),o=t(o);var a=d(o,{noinclude:!0});o=o.map(function(e){return f(e,a[1])});for(var p,c,u="",h=0;h<o.length;h++)if(p=o[h],c="","EMPTYLINE"!=p.remark)if(p.label||p.opcode||!p.remark){for(p.label&&(c+=p.label,"EQU"!=p.opcode&&"="!=p.opcode&&".SET"!=p.opcode&&(c+=":"),c+=" ");c.length<12;)c+=" ";for(p.opcode&&(c+=p.opcode+" ");c.length<20;)c+=" ";p.params&&(c+=p.params+" "),p.remark&&(c+=";"+p.remark),u+=c+"\n"}else u+=";"+p.remark+"\n";else u+="\n";return u},buff:function(e){for(var n,r,o=new Uint8Array(65536),a=0,t=e.length;a<t;a++)if(n=e[a],r=n.addr,n.lens)for(var l=0;l<n.lens.length;l++)o[r++]=n.lens[l];return o},fileGet:function(e){n=e}}});