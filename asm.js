/*

Multitarget assembler (C) 2013 Martin Maly, http://www.maly.cz, http://www.webscript.cz

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.

 Parser is based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/

/* jshint browser:true, jquery:true */
/*global define, Uint8Array*/
/* eslint-disable no-empty */

var btoa = require('btoa');
var atob = require('atob');

var ASM = {};
  var Parser = require("./parser.js").Parser;
!function(e,o){"undefined"!=typeof module?(module.exports=o(),ASM=module.exports):"function"==typeof define&&"object"==typeof define.amd?define(o):this.ASM=o()}(0,function(){"use strict";var e=null,o=null,n={},r=!1,a=function(e){return e.map(function(e){var o=e.line;for(o=(o=o.replace("&lt;","<")).replace("&gt;",">");" "==o[o.length-1];)o=o.substr(0,o.length-1);if(e.line=o," "!=o[0])return e;for(;" "==o[0];)o=o.substr(1);return e.line=" "+o,e})},t=function(e){return e.filter(function(e){for(var o=e.line;" "==o[0];)o=o.substr(1);return!!o.length})},l=function(e){return e.map(function(e){for(var o=e.line,n={addr:0,line:";;;EMPTYLINE",numline:e.numline};" "==o[0];)o=o.substr(1);return o.length?e:n})},s=function(e){var o=1;return e.map(function(e){return{line:e,numline:o++,addr:null,bytes:0}})},i=function(e){return e.replace(/^\s+|\s+$/g,"")},p=function(o,n,r,a){var t=o.line,l=t.match(/^\s*(\@{0,1}[a-zA-Z0-9-_]+):\s*(.*)/);l&&(o.label=l[1].toUpperCase(),t=l[2]),o._dp=0,o.params=[];var s=t.match(/^\s*(\=)\s*(.*)/);if(s?(o.opcode=s[1].toUpperCase(),t=s[2]):(s=t.match(/^\s*([\.a-zA-Z0-9-_]+)\s*(.*)/))&&(o.opcode=s[1].toUpperCase(),t=s[2]),t){for(;t.match(/\"(.*?)\"/g);)t=t.replace(/\"(.*?)\"/g,function(e){return"00ss"+btoa(e)+"!"});for(;t.match(/\'(.*?)\'/g);)t=t.replace(/\'(.*?)\'/g,function(e){return"00ss"+btoa('"'+e.substr(1,e.length-2)+'"')+"!"});for(;t.match(/\{(.*?)\}/g);)t=t.replace(/\{(.*?)\}/g,function(e){return"00bb"+btoa(e.substr(1,e.length-2))});for(;t.match(/"(.*?);(.*?)"/g);)t=t.replace(/"(.*?);(.*?)"/g,'"$1§$2"');for(;t.match(/'(.*?);(.*?)'/g);)t=t.replace(/'(.*?);(.*?)'/g,'"$1§$2"');var c=t.match(/^\s*([^;]*)(.*)/);if(c&&c[1].length){o.paramstring=c[1];for(var f=c[1];f.match(/"(.*?),(.*?)"/g);)f=f.replace(/"(.*?),(.*?)"/g,'"$1€$2"');for(;f.match(/'(.*?),(.*?)'/g);)f=f.replace(/'(.*?),(.*?)'/g,'"$1€$2"');var d=f.match(/([0-9]+)\s*DUP\s*\((.*)\)/i);if(d){for(var u=parseInt(d[1]),h="",m=0;m<u;m++)h+=d[2]+",";f=h.substring(0,h.length-1)}var g=f.split(/\s*,\s*/);o.params=g.map(function(e){var o=i(e.replace(/€/g,",").replace(/§/g,";"));return o=o.replace(/00ss(.*?)\!/g,function(e){return atob(e.substr(4,e.length-5))})}),t=c[2].replace(/§/g,";")}}if(t){var v=t.match(/^\s*;*(.*)/);v&&(o.remark=v[1].replace(/00ss(.*?)\!/g,function(e){return atob(e.substr(4,e.length-5))}),o.remark||(o.remark=" "),t="")}if(o.notparsed=t,"ORG"===o.opcode&&(o.opcode=".ORG"),".ERROR"===o.opcode)throw{msg:o.paramstring,s:o};if(".EQU"===o.opcode&&(o.opcode="EQU"),".FILL"===o.opcode&&(o.opcode="FILL"),".ORG"===o.opcode)try{return o}catch(e){throw{msg:e.message,s:o}}if("DEFB"===o.opcode)return o.opcode="DB",o;if(".BYTE"===o.opcode)return o.opcode="DB",o;if(".DB"===o.opcode)return o.opcode="DB",o;if(".WORD"===o.opcode)return o.opcode="DW",o;if(".DW"===o.opcode)return o.opcode="DW",o;if("DEFW"===o.opcode)return o.opcode="DW",o;if("DEFS"===o.opcode)return o.opcode="DS",o;if(".RES"===o.opcode)return o.opcode="DS",o;if("DEFM"===o.opcode)return o.opcode="DS",o;if(".ALIGN"===o.opcode)return o.opcode="ALIGN",o;if(".IF"===o.opcode)return o.opcode="IF",o;if(".ELSE"===o.opcode)return o.opcode="ELSE",o;if(".ENDIF"===o.opcode)return o.opcode="ENDIF",o;if(".PRAGMA"===o.opcode)return ASM.PRAGMAS=ASM.PRAGMAS||[],ASM.PRAGMAS.push(o.params[0].toUpperCase()),o;if("EQU"===o.opcode||"="===o.opcode||".SET"===o.opcode||"IF"===o.opcode||"IFN"===o.opcode||"ELSE"===o.opcode||"ENDIF"===o.opcode||".INCLUDE"===o.opcode||".INCBIN"===o.opcode||".MACRO"===o.opcode||".ENDM"===o.opcode||".BLOCK"===o.opcode||".ENDBLOCK"===o.opcode||".REPT"===o.opcode||".CPU"===o.opcode||".ENT"===o.opcode||".BINFROM"===o.opcode||".BINTO"===o.opcode||".ENGINE"===o.opcode||".PRAGMA"===o.opcode||"END"===o.opcode||".END"===o.opcode||"BSZ"===o.opcode||"FCB"===o.opcode||"FCC"===o.opcode||"FDB"===o.opcode||"FILL"===o.opcode||"RMB"===o.opcode||"ZMB"===o.opcode||"SETDP"===o.opcode||".M8"===o.opcode||".X8"===o.opcode||".M16"===o.opcode||".X16"===o.opcode||".PHASE"===o.opcode||".DEPHASE"===o.opcode||".SETPHASE"===o.opcode||"ALIGN"===o.opcode||".CSTR"===o.opcode||".ISTR"===o.opcode||".PSTR"===o.opcode||".CSEG"===o.opcode||".DSEG"===o.opcode||".ESEG"===o.opcode||".BSSEG"===o.opcode||"DB"===o.opcode||"DS"===o.opcode||"DW"===o.opcode)return o;if(".DEBUGINFO"===o.opcode||".MACPACK"===o.opcode||".FEATURE"===o.opcode||".ZEROPAGE"===o.opcode||".SEGMENT"===o.opcode||".SETCPU"===o.opcode)return o.opcode="",o;if(!o.opcode&&o.label)return o;try{var E=e.parseOpcode(o)}catch(e){throw{msg:e,s:o}}if(null!==E)return E;if(n[o.opcode])return o.macro=o.opcode,o;if(!o.label&&!r){var S={line:o.line,numline:o.numline,addr:null,bytes:0};if(o.remark&&!o.opcode)return o;if(!o.params||0===o.params.length)throw{msg:"Unrecognized instruction "+o.opcode,s:o};if(!o.opcode)throw{msg:"Unrecognized instruction "+o.opcode,s:o};0===o.params[0].indexOf(":=")&&(o.params[0]=o.params[0].substr(1)),S.line=o.opcode+": "+o.params.join(),o.remark&&(S.line+=" ;"+o.remark);var b=p(S,n,!0,o);if(!b.opcode)throw{msg:"Unrecognized instruction "+o.opcode,s:o};return b}if(r)throw{msg:"Unrecognized instruction "+a.opcode,s:o};throw{msg:"Unrecognized instruction "+o.opcode,s:o}},c=function(e,o){if(!o)return e;for(var n=[],r=null,a=0;a<e.length;a++){var t=e[a],l=p(t,{});if(r&&n.push(t),".ENDBLOCK"==l.opcode){if(r)return n}else if(".BLOCK"==l.opcode){if(r)return n;l.params[0].toUpperCase()==o.toUpperCase()&&(n.push(t),r=!0)}}throw{msg:"Cannot find block "+o+" in included file"}},f=function(e,r,l){var p,d,u=null;r=r||{};for(var h={},m=null,g=null,v=[],E=0,S=e.length;E<S;E++)if(p=e[E].line,d=p.match(/\s*(\.[^\s]+)(.*)/)){var b=d[1].toUpperCase(),M=d[2].match(/^\s*([^;]*)(.*)/);if(M&&M[1].length?(M[1],u=(B=M[1].split(/\s*,\s*/)).map(i)):u=null,".INCLUDE"!==b||!r.noinclude)if(".INCLUDE"!==b)if(".ENDM"!==b)if(".MACRO"!==b)if(".REPT"!==b)m?h[m].push(e[E]):v.push(e[E]);else{if(!u[0])throw{msg:"No repeat count given",s:e[E]};if(!(g=Parser.evaluate(u[0])))throw{msg:"Bad repeat count given",s:e[E]};if(m="*REPT"+e[E].numline,h[m])throw{msg:"Macro redefinition at line "+e[E].numline,s:e[E]};h[m]=[]}else{if(";"===p[0])continue;var A=null,C=p.match(/^(\S*)\s+\.MACRO/i);if(C?A=C[1]:u&&u[0]&&(A=u.shift()),!A)throw{msg:"Bad macro name at line "+e[E].numline,s:e[E]};if(":"===A[A.length-1]&&(A=A.substr(0,A.length-1)),m=A.toUpperCase(),h[m])throw{msg:"Macro "+m+" redefinition at line "+e[E].numline,s:e[E]};h[m]=[u]}else{if(!m)throw{msg:"ENDM without MACRO at line "+e[E].numline,s:e[E]};if(g){v.push({numline:e[E].numline,line:";rept unroll",addr:null,bytes:0,remark:"REPT unroll"});for(var y=0;y<g;y++)for(var P=0;P<h[m].length;P++){var N=h[m][P].line;v.push({numline:e[y].numline,line:N,addr:null,bytes:0})}}else{var D=h[m][0];v.push({numline:e[E].numline,line:";Macro define "+m,addr:null,bytes:0,listing:".macro "+m+(D?",":"")+D.join(",")});for(var I=h[m],R=0;R<I.length;R++)v.push({line:";",listing:I[R].line});v.push({line:";",listing:".endm"}),v.push({line:";",listing:" "})}m=null,g=null}else{var F="";if(u[0].indexOf(":")>=0){var B=u[0].split(":");if(u[0]=B[0],F=B[1],3==B.length)F=B[2];else if(n["*"+B[0].toUpperCase()+":"+F.toUpperCase()])continue;n["*"+B[0].toUpperCase()+":"+F.toUpperCase()]="used"}if(!u||!u[0])throw{msg:"No file name given",s:e[E]};if("THIS"==u[0].toUpperCase()&&F)w=c(l,F);else{var G=o(u[0].replace(/\"/g,""));if(!G)throw{msg:"File "+u[0]+" not found",s:e[E]};var w=s(G.split(/\n/));w=t(w);var T=w=a(w);w=c(w,F)}for(var L=f(w,{},T),R=0;R<L[0].length;R++)L[0][R].includedFile=u[0].replace(/\"/g,""),v.push(L[0][R]);for(R in L[1])h[R]=L[1][R];n[u[0].replace(/\"/g,"")]=G}}else{if(m){h[m].push(e[E]);continue}v.push(e[E])}if(m)throw{msg:"MACRO "+m+" has no appropriate ENDM",s:e[E]};return[v,h]},d=function(e,o,n,r,a){var t={line:e.line,addr:e.addr,macro:e.macro,numline:e.numline};o=o||[];var l=r||[];if(l&&l.length>o.length)throw t.numline=a,{msg:"Too few parameters for macro unrolling",s:t};for(var s=o.length-1;s>=0;s--){var i=o[s];0===i.indexOf("00bb")&&(i=atob(i.substr(4))),t.line=t.line.replace("%%"+(s+1),i),l&&l[s]&&(t.line=t.line.replace(l[s],i))}return t.line=t.line.replace("%%M","M_"+n),t.line=t.line.replace("%%m","M_"+n),t},u=function(e,o){for(var n=[],r=0;r<e.length;r++){var a=e[r];if(a.macro){var t=o[a.macro],l=t[0];n.push({remark:"*Macro unroll: "+a.line});for(var s=0;s<t.length;s++)if(0!==s){var i=d(t[s],a.params,r,l,a.numline);i.bytes=0;var c=p(i,o);if(c.macro)for(var f=u([c],o),h=0;h<f.length;h++)n.push(f[h]);else a.label&&(c.label=a.label),a.label="",c.remark=a.remark,c.macro=a.macro,a.macro=null,a.remark="",n.push(c)}}else n.push(a)}return n},h={},m=function(e,o){for(var n=e.toString(16);n.length<o;)n="0"+n;return n.toUpperCase()},g=function(e){return m(255&e,2)},v=function(e){return m(e,4)},E=function(e){return m(e,6)},S=function(e){if(ASM.PRAGMAS.RELAX)return"string"==typeof e?255&e.charCodeAt(0):255&e;if("string"==typeof e){if(1!=e.length)throw"String parameter too long ("+e+")";return 255&e.charCodeAt(0)}if(e>255)throw"Param out of bound ("+e+")";if(e<-128)throw"Param out of bound ("+e+")";return 255&e},b=function(e,o){var n=":",r=o.length,a=0;n+=g(r),n+=v(e),n+="00",a=r+Math.floor(e/256)+Math.floor(e%256);for(var t=0;t<o.length;t++)n+=g(o[t]),a+=o[t];return n+=g(256-a%256)},M=function(e,o,n){var r=0,a=[],t=16;n>1&&(t=n);for(var l="",s=0;s<o.length;s++)a.push(o[s]),++r===t&&(l+=b(e,a)+"\n",a=[],r=0,e+=t);return a.length&&(l+=b(e,a)+"\n"),l},A=function(e,o){var n="S1",r=o.length,a=0;n+=g(r+3),n+=v(e),a=r+3+Math.floor(e/256)+Math.floor(e%256);for(var t=0;t<o.length;t++)n+=g(o[t]),a+=o[t];return n+=g(256-a%256)},C=function(e,o){for(var n=0,r=[],a="",t=0;t<o.length;t++)r.push(o[t]),16==++n&&(a+=A(e,r)+"\n",r=[],n=0,e+=16);return r.length&&(a+=A(e,r)+"\n"),a},y=function(e,o){var n="S2",r=o.length,a=0;n+=g(r+4),n+=E(e),a=r+4+Math.floor(e/65536)+Math.floor(e/256)%256+Math.floor(e%256);for(var t=0;t<o.length;t++)n+=g(o[t]),a+=o[t];return n+=g(255-a%256)},P=function(e,o){for(var n=0,r=[],a="",t=0;t<o.length;t++)r.push(o[t]),16==++n&&(a+=y(e,r)+"\n",r=[],n=0,e+=16);return r.length&&(a+=y(e,r)+"\n"),a};return{parse:function(o,l){e=l,l.endian&&(r=l.endian),n={};var i=s(o.split(/\n/));i=t(i),i=a(i);var c=f(i);return i=c[0].map(function(e){return p(e,c[1])}),i=u(i,c[1])},pass1:function(n,r){var a="CSEG",t=function(){if("BSSEG"===a)throw d.opcode+" is not allowed in BSSEG"},l={},s=0,i={};r&&(i=r);for(var p,c,f,d=null,u=0,m=0,g=[],v=[],E=0,S=0,b=0,M=n.length;b<M;b++)if(d=n[b],ASM.WLINE=n[b],d.pass=1,d.segment=a,d.addr=s,d._dp=S,i._PC=s,0!==E&&(d.phase=E),"ENDIF"!==d.opcode)if("ELSE"!==d.opcode)if("IF"!==d.opcode)if("IFN"!==d.opcode)if(u)d.ifskip=!0;else if(".BLOCK"!==d.opcode)if(".ENDBLOCK"!==d.opcode){if(d.label){var A=d.label,C=!1;if("@"===A[0]&&(C=!0,A=A.substr(1),d.label=A,d.beGlobal=!0),d.beGlobal&&(C=!0),v.length>0&&(A=v.join("/")+"/"+A,i["__"+v.join("/")].push(d.label)),!r&&(i[A+"$"]||C&&void 0!==i[d.label]))throw{msg:"Redefine label "+d.label+" at line "+d.numline,s:d};i[d.label]?i[A]=i[d.label]:C&&(i[A]=s),h[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:s},i[A+"$"]=s,i[d.label]=s,C&&(i[A]=s)}try{if(".ORG"===d.opcode){s=Parser.evaluate(d.params[0],i),d.addr=s,l[a]=s;continue}if(".CSEG"===d.opcode&&(l[a]=s,a="CSEG",d.segment=a,s=l[a]||0,d.addr=s),".DSEG"===d.opcode&&(l[a]=s,a="DSEG",d.segment=a,s=l[a]||0,d.addr=s),".ESEG"===d.opcode&&(l[a]=s,a="ESEG",d.segment=a,s=l[a]||0,d.addr=s),".BSSEG"===d.opcode&&(l[a]=s,a="BSSEG",d.segment=a,s=l[a]||0,d.addr=s),".PHASE"===d.opcode){if(E)throw{message:"PHASE cannot be nested"};var y=Parser.evaluate(d.params[0],i);d.addr=s,E=y-s,s=y;continue}if(".DEPHASE"===d.opcode){d.addr=s,s-=E,E=0;continue}if("EQU"===d.opcode||".SET"===d.opcode){try{i[d.label]=Parser.evaluate(d.params[0],i)}catch(e){i[d.label]=null}h[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:i[d.label]};continue}if("="===d.opcode||":="===d.opcode){i[d.label]=Parser.evaluate(d.params[0],i),h[d.label]={defined:{line:d.numline,file:d.includedFile||"*main*"},value:i[d.label]};continue}}catch(e){throw{msg:e.message,s:d}}if("DB"===d.opcode||"FCB"===d.opcode)for(t(),d.bytes=0,c=0;c<d.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(d.params[c],i))){d.bytes++;continue}if("string"==typeof p){d.bytes+=p.length;continue}}catch(e){d.bytes++}if("FCC"===d.opcode)for(t(),d.bytes=0,c=0;c<d.params.length;c++){var P=d.params[c].trim(),N=P[0];if(P[P.length-1]!==N)throw{msg:"Delimiters does not match",s:d};d.bytes+=P.length-2}if(".CSTR"===d.opcode||".PSTR"===d.opcode||".ISTR"===d.opcode){for(t(),d.bytes=0,c=0;c<d.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(d.params[c],i))){d.bytes++;continue}if("string"==typeof p){d.bytes+=p.length;continue}}catch(e){d.bytes++}".CSTR"!==d.opcode&&".PSTR"!==d.opcode||d.bytes++}if("DS"!==d.opcode&&"RMB"!==d.opcode)if("ALIGN"!==d.opcode)if("SETDP"!==d.opcode)if("FILL"!==d.opcode)if("BSZ"!==d.opcode&&"ZMB"!==d.opcode){if("DW"===d.opcode||"FDB"===d.opcode)for(t(),d.bytes=0,c=0;c<d.params.length;c++)try{if("number"==typeof(p=Parser.evaluate(d.params[c],i))){d.bytes+=2;continue}}catch(e){d.bytes+=2}if(".INCBIN"!==d.opcode)if(".M16"!==d.opcode)if(".M8"!==d.opcode)if(".X16"!==d.opcode)if(".X8"!==d.opcode){var D=e.parseOpcode(n[b],i);D&&(t(),d=D),void 0===d.bytes&&(d.bytes=0),s+=d.bytes}else i.__MX=8;else i.__MX=16;else i.__AX=8;else i.__AX=16;else{if(t(),!d.params[0])throw{msg:"No file name given at line "+d.numline,s:d};var I=o(d.params[0],!0);if(!I)throw{msg:"Cannot find file "+d.params[0]+" for incbin",s:d};for(d.bytes=0,d.lens=[],G=0;G<I.length;G++){var R=I.charCodeAt(G);R>255&&(d.lens[d.bytes++]=R>>8),d.lens[d.bytes++]=R%256}s+=d.bytes}}else{for(t(),F=Parser.evaluate(d.params[0],i),d.bytes=F,d.lens=[],G=0;G<F;G++)d.lens[G]=0;s+=F}else{t();var F=Parser.evaluate(d.params[1],i);for("string"==typeof(p=Parser.evaluate(d.params[0],i))&&(p=p.charCodeAt(0)),d.bytes=F,d.lens=[],G=0;G<F;G++)d.lens[G]=p;s+=F}else S=Parser.evaluate(d.params[0],i);else{var B=Parser.evaluate(d.params[0],i);s+=s%B>0?B-s%B:0}else{if("number"!=typeof(F=Parser.evaluate(d.params[0],i)))throw{msg:"DS / RMB needs a numerical parameter",s:d};if(2==d.params.length){"string"==typeof(p=Parser.evaluate(d.params[1],i))&&(p=p.charCodeAt(0)),d.bytes=F,d.lens=[];for(var G=0;G<F;G++)d.lens[G]=p}s+=F}}else{for(var w=i["__"+v.join("/")],T=0;T<w.length;T++)i[w[T]]=i[v.join("/")+"/"+w[T]],delete i[v.join("/")+"/"+w[T]];v.pop(),i.__blocks=JSON.stringify(v)}else{v.push(d.numline);var L=v.join("/");i["__"+L]=[]}else{try{f=Parser.evaluate(d.params[0],i)}catch(e){}f&&(u=1),m=1,g.push(u)}else{try{f=Parser.evaluate(d.params[0],i)}catch(e){}f||(u=1),m=1,g.push(u)}else{if(!m)throw{msg:"ELSE without IF",s:d};u=(u=g.pop())?0:1,g.filter(function(e){return 1==e}).length&&(u=1),g.push(u)}else{if(!m)throw{msg:"ENDIF without IF",s:d};u=g.pop(),g.length?m=1:(m=0,u=0)}return[n,i]},pass2:function(e){for(var o,n,a=e[0],t=e[1],l=null,s=null,i=[],p=0,c=0,f=a.length;c<f;c++)try{if(l=a[c],l.pass=2,"ENDIF"===l.opcode){p=0;continue}if("ELSE"===l.opcode){p=p?0:1;continue}if(p)continue;if("IF"===l.opcode){Parser.evaluate(l.params[0],t);try{Parser.evaluate(l.params[0],t)||(p=1)}catch(e){throw{message:"IF condition mismatched"}}continue}if("IFN"===l.opcode){try{Parser.evaluate(l.params[0],t)&&(p=1)}catch(e){throw{message:"IF condition mismatched"}}continue}t._PC=l.addr;try{for(var d=Parser.usage(l.params[0].toUpperCase(),t),u=0;u<d.length;u++)h[d[u]].usage||(h[d[u]].usage=[]),h[d[u]].usage.push({line:l.numline,file:l.includedFile||"*main*"})}catch(e){}try{for(var d=Parser.usage(l.params[1].toUpperCase(),t),u=0;u<d.length;u++)h[d[u]].usage||(h[d[u]].usage=[]),h[d[u]].usage.push({line:l.numline,file:l.includedFile||"*main*"})}catch(e){}if(".BLOCK"===l.opcode){i.push(l.numline);for(var m=t["__"+i.join("/")],g=0;g<m.length;g++)t[i.join("/")+"/"+m[g]]=t[m[g]],t[m[g]]=t[i.join("/")+"/"+m[g]+"$"];continue}if(".ENDBLOCK"===l.opcode){for(var m=t["__"+i.join("/")],g=0;g<m.length;g++)t[m[g]]=t[i.join("/")+"/"+m[g]],void 0===t[m[g]]&&delete t[m[g]],t[i.join("/")+"/"+m[g]]=null;i.pop();continue}if(".ENT"===l.opcode){ASM.ENT=Parser.evaluate(l.params[0],t);continue}if(".BINFROM"===l.opcode){ASM.BINFROM=Parser.evaluate(l.params[0],t);continue}if(".BINTO"===l.opcode){ASM.BINTO=Parser.evaluate(l.params[0],t);continue}if(".SETPHASE"===l.opcode){ASM.PHASES||(ASM.PHASES={}),ASM.PHASES[l.addr]=l.params[0];continue}if(".ENGINE"===l.opcode){ASM.ENGINE=l.params[0];continue}if("EQU"===l.opcode){if(!l.label)throw{msg:"EQU without label",s:l};t[l.label]=Parser.evaluate(l.params[0],t);continue}if(".SET"===l.opcode){t[l.label]=Parser.evaluate(l.params[0],t);continue}if("DB"===l.opcode||"FCB"===l.opcode){for(o=0,l.lens=[],n=0;n<l.params.length;n++)if("number"!=typeof(E=Parser.evaluate(l.params[n],t)))if("string"!=typeof E);else for(b=0;b<E.length;b++)l.lens[o++]=E.charCodeAt(b);else l.lens[o++]=Math.floor(E%256);continue}if("FCC"===l.opcode){for(o=0,l.lens=[],n=0;n<l.params.length;n++)for(var v=l.params[n].trim(),E=(v[0],v.substr(1,v.length-2)),b=0;b<E.length;b++)l.lens[o++]=E.charCodeAt(b);continue}if(".CSTR"===l.opcode){for(o=0,l.lens=[],n=0;n<l.params.length;n++)if("number"!=typeof(E=Parser.evaluate(l.params[n],t)))if("string"!=typeof E);else for(b=0;b<E.length;b++)l.lens[o++]=E.charCodeAt(b);else l.lens[o++]=Math.floor(E%256);l.lens[o++]=0;continue}if(".PSTR"===l.opcode){for(o=1,l.lens=[],n=0;n<l.params.length;n++)if("number"!=typeof(E=Parser.evaluate(l.params[n],t)))if("string"!=typeof E);else for(b=0;b<E.length;b++)l.lens[o++]=E.charCodeAt(b);else l.lens[o++]=Math.floor(E%256);l.lens[0]=o-1;continue}if(".ISTR"===l.opcode){for(o=0,l.lens=[],n=0;n<l.params.length;n++)if("number"!=typeof(E=Parser.evaluate(l.params[n],t)))if("string"!=typeof E);else for(b=0;b<E.length;b++)l.lens[o++]=127&E.charCodeAt(b);else l.lens[o++]=Math.floor(E%128);l.lens[o-1]=128|l.lens[o-1];continue}if("DW"===l.opcode||"FDB"===l.opcode){for(o=0,l.lens=[],n=0;n<l.params.length;n++)"number"!=typeof(E=Parser.evaluate(l.params[n],t))||(r?(l.lens[o++]=Math.floor(E/256),l.lens[o++]=Math.floor(E%256)):(l.lens[o++]=Math.floor(E%256),l.lens[o++]=Math.floor(E/256)));continue}if(l.lens&&l.lens[1]&&"function"==typeof l.lens[1]&&("addr24"===l.lens[2]?(s=l.lens[1](t),r?(l.lens[3]=Math.floor(s%256),l.lens[2]=Math.floor((s>>8)%256),l.lens[1]=Math.floor(s>>16&255)):(l.lens[1]=Math.floor(s%256),l.lens[2]=Math.floor((s>>8)%256),l.lens[3]=Math.floor(s>>16&255))):"addr32"===l.lens[2]?(s=l.lens[1](t),r?(l.lens[4]=Math.floor(s%256),l.lens[3]=Math.floor((s>>8)%256),l.lens[2]=Math.floor(s>>16&255),l.lens[1]=Math.floor(s>>24&255)):(l.lens[1]=Math.floor(s%256),l.lens[2]=Math.floor((s>>8)%256),l.lens[3]=Math.floor(s>>16&255),l.lens[4]=Math.floor(s>>24&255))):null===l.lens[2]?"string"==typeof(s=l.lens[1](t))?r?(l.lens[1]=255&s.charCodeAt(0),l.lens[2]=255&s.charCodeAt(1)):(l.lens[2]=255&s.charCodeAt(0),l.lens[1]=255&s.charCodeAt(1)):r?(l.lens[2]=Math.floor(s%256),l.lens[1]=Math.floor(s/256)):(l.lens[1]=Math.floor(s%256),l.lens[2]=Math.floor(s/256)):(s=l.lens[1](t),l.lens[1]=S(s))),l.lens&&l.lens.length>2&&"function"==typeof l.lens[2]&&(s=l.lens[2](t),null===l.lens[3]?"string"==typeof(s=l.lens[2](t))?r?(l.lens[2]=255&s.charCodeAt(0),l.lens[3]=255&s.charCodeAt(1)):(l.lens[3]=255&s.charCodeAt(0),l.lens[2]=255&s.charCodeAt(1)):r?(l.lens[3]=255&s,l.lens[2]=s>>8):(l.lens[2]=255&s,l.lens[3]=s>>8):l.lens[2]=S(s)),l.lens&&l.lens.length>3&&"function"==typeof l.lens[3]&&(s=l.lens[3](t),null===l.lens[4]?"string"==typeof(s=l.lens[3](t))?r?(l.lens[3]=255&s.charCodeAt(0),l.lens[4]=255&s.charCodeAt(1)):(l.lens[4]=255&s.charCodeAt(0),l.lens[3]=255&s.charCodeAt(1)):r?(l.lens[4]=255&s,l.lens[3]=s>>8):(l.lens[3]=255&s,l.lens[4]=s>>8):l.lens[3]=S(s)),l.lens&&l.lens.length>1){if("string"==typeof l.lens[1]&&(l.lens[1]=l.lens[1].charCodeAt(0)),isNaN(l.lens[1]))throw{message:"param out of bounds, NaN"};if((l.lens[1]>255||l.lens[1]<-128)&&2==l.lens.length)throw{message:"param out of bounds - "+l.lens[1]};l.lens[1]<0&&(l.lens[1]=256+l.lens[1])}}catch(e){throw{msg:e.message,s:l,e:e}}return[a,t]},parseLine:p,ENT:null,WLINE:null,compile:function(e,o){try{ASM.ENT=null,ASM.BINFROM=null,ASM.BINTO=null,ASM.ENGINE=null,ASM.PRAGMAS=[];var n=ASM.parse(e,o);h={};var r=ASM.pass1(n);return r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass1(r[0],r[1]),r=ASM.pass2(r),[null,r,h]}catch(e){console.log(e);var a=e.s||"Internal error";return e.e&&(e="object"==typeof e.e?e.e:{msg:e.e,s:e.s}),!e.msg&&e.message&&(e.msg=e.message),e.msg?(e.s||(e.s=a),[e,null]):["Cannot evaluate line "+ASM.WLINE.numline+", there is some unspecified error (e.g. reserved world as label etc.)",null]}},compileAsync:function(e,o,n){try{var r=ASM.parse(e,o),a=ASM.pass1(r);a=ASM.pass2(a),n(null,a)}catch(e){n(e,null)}},lst:function(e,o,n,r,a){var t,l,s="";void 0===r&&(r=!1);for(var i=0,p=e.length;i<p;i++){if(l=e[i],t="",l.macro,void 0===l.addr||l.ifskip||(t+=v(l.addr),l.phase&&(t+=" @"+v(l.addr-l.phase)),t+=r?" ":"   "),l.lens&&!l.ifskip)for(var c=0;c<l.lens.length;c++)t+=g(l.lens[c])+" ";if(!r)for(;t.length<20;)t+=" ";if(r)for(;t.length<15;)t+=" ";if(l.listing)s+=t+l.listing+"\n";else{if(l.label&&(t+=l.label+":   "),!r)for(;t.length<30;)t+=" ";if(r)for(;t.length<22;)t+=" ";l.opcode&&(t+=l.opcode+(r?" ":"   ")),l.bandPar&&(t+=l.bandPar+","),l.aimPar&&(t+=l.aimPar+","),l.params&&(t+=l.params+(r?" ":"   ")),l.remark&&(t+=";"+l.remark),s+=t+"\n"}}if(n)return s;s+="\n\n";for(var f in h)if(null!==h[f]&&("_"!=f[0]||"_"!=f[1])&&"$"!==f[f.length-1]){for(t="",t+=f+": ";t.length<20;)t+=" ";if(t+=v(h[f].value),t+=" DEFINED AT LINE "+h[f].defined.line,"*main*"!=h[f].defined.file&&(t+=" IN "+h[f].defined.file),s+=t+"\n",h[f].usage)for(p=0;p<h[f].usage.length;p++)s+="                    > USED AT LINE "+h[f].usage[p].line,"*main*"!=h[f].usage[p].file&&(s+=" IN "+h[f].usage[p].file),s+="\n"}return s},html:function(e,o,n,r){var a,t,l="<html><head><meta charset=utf-8><body><table>";void 0===r&&(r=!1);for(var s=0,i=e.length;s<i;s++){if(t=e[s],a='<tr id="ln'+t.numline+'">',t.macro,void 0!==t.addr?(a+='<td><a name="ADDR'+v(t.addr)+'">'+v(t.addr)+"</a>",t.phase?a+="</td><td>"+v(t.addr-t.phase):a+="</td><td>",a+="</td>"):a+="<td></td><td></td>",t.lens){a+="<td>";for(var p=0;p<t.lens.length;p++)a+=g(t.lens[p])+" ";a+="</td>"}else a+="<td></td>";t.label?a+='<td><a name="LBL'+t.label+'">'+t.label+"</a></td>":a+="<td></td>",t.opcode?a+="<td>"+t.opcode+"</td>":a+="<td></td>",t.params?a+="<td>"+t.params.map(function(e){e+="";for(var n in o)if(null!==o[n]&&("_"!=n[0]||"_"!=n[1])&&"$"!==n[n.length-1]){var r=new RegExp("^"+n+"$","i");if(e.match(r))return'<a href="#LBL'+n+'">'+e+"</a>"}return e})+"</td>":a+="<td></td>",t.remark?a+="<td>;"+t.remark+"</td>":a+="<td></td>",l+=a+"</tr>\n"}return l+="</table>"},hex:function(e,o){for(var n,r=null,a=0,t=[],l="",s=!1,i=16,p=0,c=e.length;p<c;p++)if(".PRAGMA"===(n=e[p]).opcode&&(2==n.params.length&&"HEXLEN"==n.params[0].toUpperCase()&&((i=parseInt(n.params[1]))<1||i>64)&&(i=16),1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(s=!0)),!(n.ifskip||s&&(o||(o="CSEG"),n.segment!=o))){var f=n.addr;if(n.phase&&(f-=n.phase),void 0!==f&&0===a&&(r=f),f!=r+a&&(a&&(l+=M(r,t,i)),r=f,a=0,t=[]),n.lens){for(var d=0;d<n.lens.length;d++)t.push(n.lens[d]);a+=n.lens.length}}return t.length&&(l+=M(r,t,i)),l+=":00000001FF"},srec:function(e,o){for(var n,r=null,a=0,t=!1,l=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(n=e[i]).opcode&&1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(t=!0),!(n.ifskip||t&&(o||(o="CSEG"),n.segment!=o))){var c=n.addr;if(n.phase&&(c-=n.phase),void 0!==c&&0===a&&(r=c),c!=r+a&&(a&&(s+=C(r,l)),r=c,a=0,l=[]),n.lens){for(var f=0;f<n.lens.length;f++)l.push(n.lens[f]);a+=n.lens.length}}l.length&&(s+=C(r,l));var d=ASM.ENT||0,u=3+Math.floor(d/256)+Math.floor(d%256);return s+="S903"+v(d)+g(255-u%256)},srec28:function(e,o){for(var n,r=null,a=0,t=!1,l=[],s="",i=0,p=e.length;i<p;i++)if(".PRAGMA"===(n=e[i]).opcode&&1==n.params.length&&"SEGMENT"==n.params[0].toUpperCase()&&(t=!0),!t||(o||(o="CSEG"),n.segment==o)){var c=n.addr;if(n.phase&&(c-=n.phase),void 0!==c&&0===a&&(r=c),c!=r+a&&(a&&(s+=P(r,l)),r=c,a=0,l=[]),n.lens){for(var f=0;f<n.lens.length;f++)l.push(n.lens[f]);a+=n.lens.length}}l.length&&(s+=P(r,l));var d=ASM.ENT||0,u=3+Math.floor(d/256)+Math.floor(d%256);return s+="S804"+E(d)+g(255-u%256)+"\n"},linemap:function(e){for(var o,n=[],r=null,a=0,t=e.length;a<t;a++)if(".PHASE"!==(o=e[a]).opcode||""===o.label)if(".DEPHASE"!==o.opcode){if(o.lens)for(var l=0;l<o.lens.length;l++)r?n[o.addr+l]?n[o.addr+l][r]=a+1:(n[o.addr+l]={},n[o.addr+l][r]=a+1):n[o.addr+l]=a+1}else r=null;else r=o.label;return n},beautify:function(o,n){e=n;var r=s(o.split(/\n/));r=l(r),r=t(r),r=a(r);var i=f(r,{noinclude:!0});r=r.map(function(e){return p(e,i[1])});for(var c,d,u="",h=0;h<r.length;h++)if(c=r[h],d="","EMPTYLINE"!=c.remark)if(c.label||c.opcode||!c.remark){for(c.label&&(d+=c.label,"EQU"!=c.opcode&&"="!=c.opcode&&".SET"!=c.opcode&&(d+=":"),d+=" ");d.length<12;)d+=" ";for(c.opcode&&(d+=c.opcode+" ");d.length<20;)d+=" ";c.params&&(d+=c.params+" "),c.remark&&(d+=";"+c.remark),u+=d+"\n"}else u+=";"+c.remark+"\n";else u+="\n";return u},buff:function(e){for(var o,n,r=new Uint8Array(65536),a=0,t=e.length;a<t;a++)if(o=e[a],n=o.addr,o.lens)for(var l=0;l<o.lens.length;l++)r[n++]=o.lens[l];return r},fileGet:function(e){o=e}}});